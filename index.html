<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiss Army Spinner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; color: white; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        /* Animated Backgrounds */
        .animated-bg { background-size: 400% 400%; animation: gradientBG 15s ease infinite; }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(156, 163, 175, 0.8); }

        /* Animation utilities */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
/* --- 3D ANIMATIONS (SMARTER) --- */
        /* COIN */
        .coin-container { perspective: 1000px; width: 150px; height: 150px; margin: 0 auto; position: relative; }
        .coin { width: 100%; height: 100%; transform-style: preserve-3d; position: relative; }
        .coin-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%; box-shadow: inset 0 0 15px rgba(0,0,0,0.3); border: 8px solid #cbd5e1; }
        
        /* HEADS: Silver/Blue */
        .face-heads { background: radial-gradient(circle, #f8fafc, #94a3b8); color: #334155; font-size: 1.5rem; }
        /* TAILS: Gold/Orange */
        .face-tails { transform: rotateY(180deg); background: radial-gradient(circle, #fef3c7, #d97706); color: #78350f; font-size: 1.5rem; border-color: #f59e0b; }

        /* Animation Classes */
        .flip-to-heads { animation: flipHeads 2.5s cubic-bezier(0.1, 0.7, 0.6, 1) forwards; }
        .flip-to-tails { animation: flipTails 2.5s cubic-bezier(0.1, 0.7, 0.6, 1) forwards; }
        @keyframes flipHeads { 0% { transform: rotateY(0); } 100% { transform: rotateY(1800deg); } } /* Lands on 0 (Front) */
        @keyframes flipTails { 0% { transform: rotateY(0); } 100% { transform: rotateY(1980deg); } } /* Lands on 180 (Back) */

        /* DICE */
        .dice-container { perspective: 1000px; width: 100px; height: 100px; margin: 20px auto; }
        .dice { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; }
        .dice-face { position: absolute; width: 100px; height: 100px; background: white; border: 2px solid #ccc; border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold; color: #333; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); backface-visibility: hidden;}
        
        /* Standard Dice Mapping */
        .df-1 { transform: translateZ(50px); }
        .df-2 { transform: rotateX(-90deg) translateZ(50px); }
        .df-3 { transform: rotateY(-90deg) translateZ(50px); }
        .df-4 { transform: rotateY(90deg) translateZ(50px); }
        .df-5 { transform: rotateX(90deg) translateZ(50px); }
        .df-6 { transform: rotateY(180deg) translateZ(50px); }

        /* Dice Roll Animations (Targeting specific numbers) */
        .roll-to-1 { animation: roll1 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }
        .roll-to-2 { animation: roll2 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }
        .roll-to-3 { animation: roll3 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }
        .roll-to-4 { animation: roll4 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }
        .roll-to-5 { animation: roll5 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }
        .roll-to-6 { animation: roll6 2s cubic-bezier(0.1, 0.8, 0.2, 1) forwards; }

        @keyframes roll1 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(720deg); } }
        @keyframes roll2 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(810deg) rotateY(720deg); } }
        @keyframes roll3 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(810deg); } }
        @keyframes roll4 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(630deg); } }
        @keyframes roll5 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(630deg) rotateY(720deg); } }
        @keyframes roll6 { 0% { transform: rotateX(0) rotateY(0); } 100% { transform: rotateX(720deg) rotateY(900deg); } }
   
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        // --- DRAGGABLE HELPER ---
        const DraggableBox = ({ children, x=0, y=0, style={}, className="" }) => {
            const [pos, setPos] = useState({x, y});
            const [dragging, setDragging] = useState(false);
            const offset = useRef({x:0, y:0});

            useEffect(() => {
                const move = (e) => {
                    if(dragging) setPos({ x: e.clientX - offset.current.x, y: e.clientY - offset.current.y });
                };
                const up = () => setDragging(false);
                if(dragging) {
                    window.addEventListener('mousemove', move);
                    window.addEventListener('mouseup', up);
                }
                return () => {
                    window.removeEventListener('mousemove', move);
                    window.removeEventListener('mouseup', up);
                };
            }, [dragging]);

            const start = (e) => {
                // Don't drag if clicking buttons or the resize handle (bottom-right)
                if(e.target.tagName === 'BUTTON' || e.target.tagName === 'SELECT' || e.target.tagName === 'OPTION') return;
                const rect = e.currentTarget.getBoundingClientRect();
                if(e.clientX > rect.right - 20 && e.clientY > rect.bottom - 20) return; // Resize zone
                
                setDragging(true);
                offset.current = { x: e.clientX - pos.x, y: e.clientY - pos.y };
            };

            return (
                <div onMouseDown={start} style={{...style, position:'absolute', left:pos.x, top:pos.y, cursor: dragging ? 'grabbing' : 'grab', userSelect:'none'}} className={className}>
                    {children}
                </div>
            );
        };
        
        // --- ICONS ---
        const Icons = {
          Settings: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
          Shuffle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>,
          ArrowDown: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
          Volume2: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>,
          VolumeX: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>,
          Trophy: () => <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
          X: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
          UserMinus: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
          Save: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
          Folder: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>,
          Palette: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="8.5" cy="7.5" r=".5"/><circle cx="6.5" cy="12.5" r=".5"/><path d="M12 22C6.5 22 2 17.5 2 12S6.5 2 12 2s10 4.5 10 10c0 1.28-.75 2.37-1.83 2.92-.71.36-1.17 1.05-1.17 1.83 0 .7.56 1.25 1.25 1.25H20"/></svg>,
          Eye: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
          EyeOff: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
          Trash: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
          Maximize: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect><line x1="12" y1="2" x2="12" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line></svg>,
          Minimize: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>,
          Clock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
    
          Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
          Pause: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>,
          RotateCcw: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
          Bell: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
          HelpCircle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
          Star: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
          Clipboard: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
          History: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
          Users: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
          Copy: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
          Check: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
          Swords: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M13 19l6-6"/><path d="M16 16l4 4"/><path d="M19 21l2-2"/></svg>,
          Brain: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
       
          Edit: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
          Refresh: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
          Scales: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
          ThumbsUp: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>,
          ThumbsDown: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 15v4a3 3 0 0 0 3 3l4-9V2H5.72a2 2 0 0 0-2 1.7l-1.38 9a2 2 0 0 0 2 2.3zm7-13h2.67A2.31 2.31 0 0 1 22 4v7a2.31 2.31 0 0 1-2.33 2H17"/></svg>,
          Zap: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
          BarChart: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
        };
        // --- 2. THEMES & UTILS ---
        const THEMES = {
          modern: { 
              name: "Dark Modern", 
              colors: ['#EF4444', '#F97316', '#F59E0B', '#10B981', '#06B6D4', '#3B82F6', '#6366F1', '#8B5CF6', '#EC4899', '#F43F5E'], 
              bg: "#0f172a", 
              sidebar: "#1e293b", 
              text: "#f1f5f9", 
              accent: "#7c3aed",
              grad: "linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%)" 
          },
          pastel: { 
              name: "Soft Pastel", 
              colors: ['#fca5a5', '#fdba74', '#fcd34d', '#86efac', '#67e8f9', '#93c5fd', '#a5b4fc', '#c4b5fd', '#f9a8d4', '#fda4af'], 
              bg: "#f8fafc", 
              sidebar: "#ffffff", 
              text: "#334155", 
              accent: "#ec4899",
              grad: "linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)" 
          },
          nature: { 
              name: "Forest Hike", 
              colors: ['#4d7c0f', '#15803d', '#047857', '#0f766e', '#a16207', '#b45309', '#d97706', '#65a30d'], 
              bg: "#1c1917", 
              sidebar: "#292524", 
              text: "#e7e5e4", 
              accent: "#65a30d", 
              pattern: "repeating-linear-gradient(45deg, #1c1917, #1c1917 10px, #292524 10px, #292524 20px)" 
          },
          classic: { 
              name: "Classroom", 
              colors: ['#ef4444', '#3b82f6', '#eab308', '#22c55e', '#a855f7'], 
              bg: "#f0f0f0", 
              sidebar: "#ffffff", 
              text: "#1f2937", 
              accent: "#2563eb", 
              pattern: "linear-gradient(to right, #e5e5f7 1px, transparent 1px), linear-gradient(to bottom, #e5e5f7 1px, transparent 1px)",
              bgSize: "20px 20px"
          }
        };
        const playSound = (type, audioCtxRef, theme = 'standard') => {
          try {
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (!AudioContextClass) return;
            if (!audioCtxRef.current) audioCtxRef.current = new AudioContextClass();
            if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume().catch(() => {});
            const ctx = audioCtxRef.current;
            
            // --- GAME SHOW FX ---
            if (type === 'correct') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'sine'; o.frequency.setValueAtTime(600, ctx.currentTime);
                 o.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.1);
                 g.gain.setValueAtTime(0, ctx.currentTime);
                 g.gain.linearRampToValueAtTime(0.3, ctx.currentTime + 0.05); g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                 o.start(); o.stop(ctx.currentTime + 0.5);
                 setTimeout(() => {
                     const o2 = ctx.createOscillator(); const g2 = ctx.createGain();
                     o2.connect(g2); g2.connect(ctx.destination);
                     o2.type = 'triangle'; o2.frequency.setValueAtTime(1200, ctx.currentTime);
                     g2.gain.setValueAtTime(0.2, ctx.currentTime); 
                     g2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
                     o2.start(); o2.stop(ctx.currentTime + 0.5);
                 }, 100);
                 return;
            }
            if (type === 'wrong') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'sawtooth'; o.frequency.setValueAtTime(150, ctx.currentTime);
                 o.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.3);
                 g.gain.setValueAtTime(0.2, ctx.currentTime);
                 g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
                 o.start(); o.stop(ctx.currentTime + 0.4);
                 return;
            }
            if (type === 'drumroll') {
                 const o = ctx.createOscillator();
                 const g = ctx.createGain();
                 o.connect(g); g.connect(ctx.destination);
                 o.type = 'square'; o.frequency.setValueAtTime(50, ctx.currentTime);
                 g.gain.setValueAtTime(0.05, ctx.currentTime); 
                 o.start(); o.stop(ctx.currentTime + 1.0);
                 return;
            }

            // --- STANDARD THEMES ---
            if (theme === 'standard') {
                if (type === 'tick') {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.type = 'triangle'; osc.frequency.setValueAtTime(600, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.05);
                    gain.gain.setValueAtTime(0.2, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
                    osc.start(); osc.stop(ctx.currentTime + 0.06);
                } else if (type === 'win') {
                    [440, 554, 659, 880].forEach((freq, i) => {
                        const o = ctx.createOscillator(); const g = ctx.createGain();
                        o.type = 'square'; o.frequency.value = freq;
                        o.connect(g); g.connect(ctx.destination);
                        g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.1, ctx.currentTime + 0.05);
                        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);
                        o.start(ctx.currentTime + i * 0.1); o.stop(ctx.currentTime + 1.5);
                    });
                }
            } else if (theme === 'arcade') {
                if (type === 'tick') {
                     const o = ctx.createOscillator();
                     const g = ctx.createGain();
                     o.type = 'square'; o.frequency.setValueAtTime(200, ctx.currentTime);
                     o.connect(g); g.connect(ctx.destination);
                     g.gain.setValueAtTime(0.1, ctx.currentTime); g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.03);
                     o.start();
                     o.stop(ctx.currentTime + 0.03);
                } else if (type === 'win') {
                     [523, 659, 784, 1046, 784, 1046].forEach((f, i) => {
                         const o = ctx.createOscillator(); const g = ctx.createGain();
                         o.type = 'sawtooth'; o.frequency.value = f;
                         o.connect(g); g.connect(ctx.destination);
                         g.gain.setValueAtTime(0.1, ctx.currentTime + i * 0.1); g.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.1 + 0.1);
                         o.start(ctx.currentTime + i * 0.1); o.stop(ctx.currentTime + i * 0.1 + 0.1);
                     });
                }
            } else if (theme === 'spooky') {
                if (type === 'tick') {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.type = 'sine'; o.frequency.setValueAtTime(100, ctx.currentTime); o.frequency.linearRampToValueAtTime(50, ctx.currentTime + 0.1);
                    o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.3, ctx.currentTime);
                    g.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.1);
                    o.start(); o.stop(ctx.currentTime + 0.1);
                } else if (type === 'win') {
                     const o = ctx.createOscillator();
                     const g = ctx.createGain();
                     o.type = 'sine'; o.frequency.setValueAtTime(300, ctx.currentTime); o.frequency.linearRampToValueAtTime(600, ctx.currentTime + 1); o.frequency.linearRampToValueAtTime(200, ctx.currentTime + 2);
                     o.connect(g); g.connect(ctx.destination);
                     g.gain.setValueAtTime(0, ctx.currentTime); g.gain.linearRampToValueAtTime(0.2, ctx.currentTime + 0.5); g.gain.linearRampToValueAtTime(0, ctx.currentTime + 2.5);
                     o.start(); o.stop(ctx.currentTime + 2.5);
                }
            }
            if (type === 'bell') {
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain); gain.connect(ctx.destination);
              osc.type = 'sine'; osc.frequency.setValueAtTime(523.25, ctx.currentTime);
              gain.gain.setValueAtTime(0.1, ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2.0);
              osc.start();
              osc.stop(ctx.currentTime + 2.0);
            }
          } catch (e) { console.warn("Audio play failed", e);
          }
        };

        const FireConfetti = (canvas) => {
          if (!canvas) return;
          const ctx = canvas.getContext('2d'); if (!ctx) return;
          canvas.width = window.innerWidth; canvas.height = window.innerHeight;
          let particles = [];
          const colors = ['#ef4444', '#eab308', '#3b82f6', '#22c55e'];
          for (let i=0; i<200; i++) particles.push({x:canvas.width/2,y:canvas.height/2,vx:(Math.random()-0.5)*25,vy:(Math.random()-0.5)*25,size:Math.random()*12+6,color:colors[Math.floor(Math.random()*colors.length)],life:120,decay:Math.random()*0.04+0.01});
          const animate = () => { ctx.clearRect(0,0,canvas.width,canvas.height);
          let active = false; particles.forEach(p=>{ if(p.life>0){ active=true; p.x+=p.vx; p.y+=p.vy; p.vy+=0.4; p.life-=1; p.size*=0.95; ctx.fillStyle=p.color; ctx.globalAlpha=Math.min(p.life/20,1); ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); } });
          if(active) requestAnimationFrame(animate); else ctx.clearRect(0,0,canvas.width,canvas.height); };
          animate();
        };

        const defaultNames = ["Emma", "Liam", "Olivia", "Noah", "Ava"];
        const defaultConcepts = ["Remember", "Understand", "Apply", "Analyze", "Evaluate", "Create"];

        // --- 3. SUB-COMPONENTS ---

const Timer = ({ audioCtx, onClose }) => {
          const [mode, setMode] = useState('stopwatch');
          const [time, setTime] = useState(0); 
          const [isRunning, setIsRunning] = useState(false); const [initialTime, setInitialTime] = useState(0);
          const timeOptions = [{label:'5s',val:5},{label:'10s',val:10},{label:'20s',val:20},{label:'30s',val:30},{label:'60s',val:60},{label:'2 min',val:120},{label:'3 min',val:180},{label:'4 min',val:240},{label:'5 min',val:300},{label:'10 min',val:600},{label:'20 min',val:1200},{label:'30 min',val:1800},{label:'1 hour',val:3600}];
          useEffect(() => {
            let interval;
            if (isRunning) { interval = setInterval(() => { setTime(prev => { if (mode === 'timer') { if (prev <= 1) { playSound('bell', audioCtx); setIsRunning(false); return 0; } return prev - 1; } return prev + 1; }); }, 1000); }
            return () => clearInterval(interval);
          }, [isRunning, mode, audioCtx]);
          const formatTime = (s) => { const mins = Math.floor(s/60); const secs = s%60; return mins>=60?`${Math.floor(mins/60)}:${(mins%60).toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`:`${mins}:${secs.toString().padStart(2,'0')}`; };
          const handleSelectTime = (e) => { const seconds = parseInt(e.target.value); if (!isNaN(seconds)) { setMode('timer'); setInitialTime(seconds); setTime(seconds); setIsRunning(false); } };
          const handleReset = () => { setIsRunning(false); setTime(mode === 'timer' ? initialTime : 0); };
return (
            <DraggableBox x={16} y={70} style={{zIndex:40}}>
                <div style={{
                    padding:'12px', background:'rgba(15,23,42,0.85)', backdropFilter:'blur(8px)',
                    borderRadius:'12px', border:'1px solid rgba(255,255,255,0.15)',
                    boxShadow:'0 4px 20px rgba(0,0,0,0.4)', display:'flex', flexDirection:'column',
                    gap:'8px', minWidth:'160px', resize:'both', overflow:'hidden'
                }}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <div style={{fontSize:'1.8rem',fontWeight:800,fontFamily:'monospace',lineHeight:1,fontVariantNumeric:'tabular-nums',color:time<=10&&mode==='timer'&&time>0?'#ef4444':'#fff'}}>{formatTime(time)}</div>
                      <button onClick={onClose} style={{background:'none',border:'none',color:'#94a3b8',cursor:'pointer',padding:4}}><Icons.X/></button>
                  </div>
                 
                  <select onChange={handleSelectTime} style={{background:'rgba(255,255,255,0.1)',border:'1px solid rgba(255,255,255,0.1)',color:'#fff',padding:'6px',borderRadius:'6px',fontSize:'0.85rem',outline:'none',cursor:'pointer',width:'100%'}} defaultValue=""><option value="" disabled>Set Duration...</option>{timeOptions.map((opt,i)=>(<option key={i} value={opt.val} style={{color:'#000'}}>{opt.label}</option>))}</select>
                  <div style={{display:'flex',gap:8}}>
                    <button onClick={()=>setIsRunning(!isRunning)} className="btn" style={{flex:1,background:isRunning?'#ef4444':'#22c55e',color:'white',justifyContent:'center',padding:'8px',height:'36px'}}>{isRunning?<Icons.Pause/>:<Icons.Play/>}</button>
                    <button onClick={handleReset} className="btn" style={{background:'rgba(255,255,255,0.1)',justifyContent:'center',padding:'8px',height:'36px',width:'36px'}}><Icons.RotateCcw/></button>
                  </div>
                </div>
            </DraggableBox>
          );
        };

        const Scoreboard = ({ teams, scores, onUpdateScore, onClose }) => {
          return (
            <div style={{position:'absolute',bottom:0,left:0,right:0,background:'rgba(15,23,42,0.95)',borderTop:'1px solid rgba(255,255,255,0.1)',backdropFilter:'blur(10px)',padding:'16px',zIndex:45,display:'flex',gap:16,overflowX:'auto',alignItems:'center'}}>
                <div style={{display:'flex',alignItems:'center',gap:12,marginRight:'auto'}}><span style={{fontWeight:800,fontSize:'1.2rem',color:'#7c3aed',textTransform:'uppercase',letterSpacing:1}}>Scoreboard</span><button onClick={onClose} className="btn" style={{background:'rgba(255,255,255,0.1)',padding:6}}><Icons.X/></button></div>
                {teams.map((group, i) => (<div key={i} style={{background:'rgba(255,255,255,0.05)',padding:'8px 16px',borderRadius:8,display:'flex',flexDirection:'column',alignItems:'center',minWidth:100,border:'1px solid rgba(255,255,255,0.1)'}}><span style={{fontSize:'0.75rem',opacity:0.7,marginBottom:4}}>Team {i+1}</span><span style={{fontSize:'1.5rem',fontWeight:800,lineHeight:1,marginBottom:8}}>{scores[i]}</span><div style={{display:'flex',gap:4}}><button onClick={()=>onUpdateScore(i,-1)} className="btn" style={{padding:'2px 8px',background:'rgba(239,68,68,0.2)',color:'#f87171',fontSize:'1rem'}}>-</button><button onClick={()=>onUpdateScore(i,1)} className="btn" style={{padding:'2px 8px',background:'rgba(34,197,94,0.2)',color:'#4ade80',fontSize:'1rem'}}>+</button></div></div>))}
    
            </div>
          );
        };
        const GroupMakerModal = ({ names, onClose, onStartScoring }) => {
            const [groupCount, setGroupCount] = useState(4);
            const [groups, setGroups] = useState([]); const [copied, setCopied] = useState(false);
            const groupOptions = [2, 3, 4, 5, 6, 7, 8, 9, 10];
            const generateGroups = () => {
                if (names.length === 0) return;
                const shuffled = [...names].sort(() => Math.random() - 0.5);
                const newGroups = Array.from({ length: groupCount }, () => []);
                shuffled.forEach((name, i) => { newGroups[i % groupCount].push(name); });
                setGroups(newGroups);
                setCopied(false);
            };
            const copyToClipboard = () => {
                let text = "";
                groups.forEach((group, i) => { text += `Team ${i + 1}:\n` + group.map(m => `- ${m}`).join('\n') + "\n\n"; });
                navigator.clipboard.writeText(text);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };
            useEffect(() => { generateGroups(); }, [groupCount]);
            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth:800,width:'90%',textAlign:'left',maxHeight:'85vh',display:'flex',flexDirection:'column'}}>
                         <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h2 style={{margin:0,fontSize:'1.5rem'}}>Instant Team Maker</h2><button onClick={onClose} className="btn" style={{padding:4}}><Icons.X/></button></div>
                         <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:20,background:'rgba(128,128,128,0.1)',padding:12,borderRadius:8,flexWrap:'wrap'}}>
  
                             <span style={{fontWeight:600}}>Split into:</span>
                            <select value={groupCount} onChange={(e)=>setGroupCount(parseInt(e.target.value))} style={{padding:'8px 12px',borderRadius:6,border:'1px solid rgba(128,128,128,0.3)',background:'var(--bg-color)',color:'inherit',fontSize:'1rem',fontWeight:700,cursor:'pointer',outline:'none'}}>
                                {groupOptions.map(num=>(<option key={num} value={num}>{num} Teams</option>))}
   
                             </select>
                            <button onClick={generateGroups} className="btn" style={{background:'rgba(128,128,128,0.2)'}}><Icons.Shuffle/> Reshuffle</button>
                            <button onClick={copyToClipboard} className="btn" style={{background:'rgba(128,128,128,0.2)'}}>{copied?<><Icons.Check/> Copied!</>:<><Icons.Copy/> Copy List</>}</button>
         
                             <button onClick={()=>onStartScoring(groups)} className="btn" style={{background:'#7c3aed',color:'white',marginLeft:'auto',boxShadow:'0 4px 12px rgba(124,58,237,0.3)'}}><Icons.Trophy/> Start Scoring</button>
                         </div>
                         <div style={{flex:1,overflowY:'auto',display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:12}}>{groups.map((group,i)=>(<div key={i} style={{background:'rgba(128,128,128,0.1)',padding:12,borderRadius:8,border:'1px solid rgba(128,128,128,0.1)'}}><div style={{fontWeight:800,color:'#7c3aed',marginBottom:8,borderBottom:'1px solid rgba(128,128,128,0.1)',paddingBottom:4}}>Team {i+1}</div>{group.map((member,j)=>(<div key={j} style={{fontSize:'0.9rem',padding:'2px 0'}}>{member}</div>))}</div>))}</div>
           
                     </div>
                </div>
            );
        };

const HelpModal = ({ onClose }) => (
            <div className="modal-overlay">
              <div className="modal" style={{maxWidth:600, textAlign:'left'}}>
                 <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:20}}>
                     <h2 style={{margin:0, fontSize:'1.5rem'}}>Swiss Army Guide</h2>
                     <button onClick={onClose} className="btn" style={{padding:4}}><Icons.X/></button>
                 </div>
                 
                 <div style={{display:'flex', flexDirection:'column', gap:16, maxHeight:'60vh', overflowY:'auto', paddingRight:12}}>
                    
                    {/* BASICS */}
                    <div style={{background:'rgba(128,128,128,0.05)', padding:10, borderRadius:8}}>
                        <div style={{fontWeight:800, color:'#fbbf24', marginBottom:4, textTransform:'uppercase', fontSize:'0.8rem'}}>The Basics</div>
                        <div style={{marginBottom:4}}>
                            <span style={{fontWeight:700}}>Spinning:</span> Press <span style={{background:'rgba(255,255,255,0.1)', padding:'2px 6px', borderRadius:4, fontFamily:'monospace'}}>Spacebar</span> or click "SPIN".
                        </div>
                        <div>
                            <span style={{fontWeight:700}}>Hide Names:</span> Click any name chip in the list to temporarily skip them (shown with strikethrough).
                        </div>
                    </div>

                    {/* SAVING & ROSTERS */}
                    <div style={{background:'rgba(128,128,128,0.05)', padding:10, borderRadius:8}}>
                        <div style={{fontWeight:800, color:'#3b82f6', marginBottom:4, textTransform:'uppercase', fontSize:'0.8rem'}}>Class Management</div>
                        <div style={{marginBottom:8}}>
                            <div style={{fontWeight:700, display:'flex', alignItems:'center', gap:6}}><Icons.Save/> Saving a Class</div>
                            <div style={{fontSize:'0.9rem', opacity:0.8, marginLeft:24}}>
                                Type a name (e.g., "Period 1") in the top box and click the <Icons.Save/> button. It saves to your browser automatically.
                            </div>
                        </div>
                        <div>
                            <div style={{fontWeight:700, display:'flex', alignItems:'center', gap:6}}><Icons.Clipboard/> Importing Rosters</div>
                            <div style={{fontSize:'0.9rem', opacity:0.8, marginLeft:24}}>
                                Click <b>Import</b> in the Tools menu. You can paste a list of names or upload a <b>.txt</b> or <b>.csv</b> file from your computer.
                            </div>
                        </div>
                    </div>

                    {/* MODES */}
                    <div style={{background:'rgba(128,128,128,0.05)', padding:10, borderRadius:8}}>
                        <div style={{fontWeight:800, color:'#ec4899', marginBottom:4, textTransform:'uppercase', fontSize:'0.8rem'}}>Game Modes</div>
                        <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:10}}>
                            <div>
                                <div style={{fontWeight:700}}><Icons.Swords/> Battle</div>
                                <div style={{fontSize:'0.85rem', opacity:0.8}}>Picks two students to face off.</div>
                            </div>
                            <div>
                                <div style={{fontWeight:700}}><Icons.Scales/> Fair Mode</div>
                                <div style={{fontSize:'0.85rem', opacity:0.8}}>Ensures everyone is picked once before repeating.</div>
                            </div>
                            <div>
                                <div style={{fontWeight:700}}><Icons.Brain/> Concept</div>
                                <div style={{fontSize:'0.85rem', opacity:0.8}}>Adds a second wheel for topics/questions.</div>
                            </div>
                            <div>
                                <div style={{fontWeight:700}}><Icons.BarChart/> Heatmap</div>
                                <div style={{fontSize:'0.85rem', opacity:0.8}}>Tracks participation. Click "Export CSV" to save data.</div>
                            </div>
                        </div>
                    </div>

                 </div>
           
                  <div style={{marginTop:20, textAlign:'center'}}>
                      <button onClick={onClose} className="btn btn-primary" style={{width:'100%', fontSize:'1rem', padding:12}}>Let's Play!</button>
                  </div>
              </div>
            </div>
        );
        const ImportModal = ({ onClose, onImport }) => {
            const [text, setText] = useState("");
            const fileInputRef = useRef(null);
            const handleFileUpload = (e) => { const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = (event) => { setText(event.target.result); }; reader.readAsText(file); };
            const handleImport = () => { if (!text.trim()) return; const splitNames = text.split(/[\n,;]+/).map(n => n.trim()).filter(n => n.length > 0);
            if (splitNames.length > 0) onImport(splitNames); };
            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth:500,textAlign:'left'}}>
                         <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h2 style={{margin:0,fontSize:'1.5rem'}}>Import List</h2><button onClick={onClose} className="btn" style={{padding:4}}><Icons.X/></button></div>
                       
                          <p style={{fontSize:'0.9rem',opacity:0.8,marginBottom:12}}>Paste your list or upload a <b>.csv/.txt</b> file.</p>
                         <div style={{marginBottom:16}}><input type="file" accept=".csv,.txt,.text" ref={fileInputRef} style={{display:'none'}} onChange={handleFileUpload}/><button onClick={() => fileInputRef.current.click()} className="btn" style={{width:'100%',justifyContent:'center',background:'rgba(128,128,128,0.1)',border:'1px dashed rgba(128,128,128,0.4)'}}><Icons.Folder /> Choose File</button></div>
                         <textarea value={text} onChange={(e)=>setText(e.target.value)} className="textarea" placeholder="Paste names..." style={{minHeight:200,marginBottom:20}}/>
                  
                          <div style={{display:'flex',gap:12,justifyContent:'flex-end'}}><button onClick={onClose} className="btn" style={{background:'rgba(128,128,128,0.2)'}}>Cancel</button><button onClick={handleImport} className="btn" style={{background:'#7c3aed',color:'white'}}>Import</button></div>
                    </div>
                </div>
            );
        };

        const ConceptModal = ({ concepts, onClose, onSave }) => {
            const [text, setText] = useState(concepts.join('\n'));
            const handleSave = () => {
                const split = text.split(/[\n,;]+/).map(n => n.trim()).filter(n => n.length > 0);
                if (split.length > 0) onSave(split);
                onClose();
            };
            return (
                <div className="modal-overlay">
                    <div className="modal" style={{maxWidth:500,textAlign:'left'}}>
                         <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:20}}><h2 style={{margin:0,fontSize:'1.5rem'}}>Edit Concepts</h2><button onClick={onClose} className="btn" style={{padding:4}}><Icons.X/></button></div>
                      
                          <p style={{fontSize:'0.9rem',opacity:0.8,marginBottom:12}}>Enter items for the 2nd wheel (e.g., questions, prizes, or taxonomy levels).</p>
                         <textarea value={text} onChange={(e)=>setText(e.target.value)} className="textarea" placeholder="Item 1&#10;Item 2..." style={{minHeight:200,marginBottom:20}}/>
                         <div style={{display:'flex',gap:12,justifyContent:'flex-end'}}><button onClick={onClose} className="btn" style={{background:'rgba(128,128,128,0.2)'}}>Cancel</button><button onClick={handleSave} className="btn" style={{background:'#7c3aed',color:'white'}}>Save Changes</button></div>
                    
                    </div>
                </div>
            );
        };

        const WinnerTimer = ({ duration, onComplete }) => {
            const [timeLeft, setTimeLeft] = useState(duration);
            useEffect(() => {
                if (timeLeft <= 0) { onComplete(); return; }
                const interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                return () => clearInterval(interval);
            }, [timeLeft, onComplete]);
            return (
                <div style={{fontSize: '1.2rem', fontWeight: 800, color: timeLeft <= 5 ? '#ef4444' : '#fbbf24', marginTop: 8}}>
                    {timeLeft}s
                </div>
            );
        };

        // --- 4. MAIN APP ---
        function App() {
          const [names, setNames] = useState(defaultNames);
          const [inputText, setInputText] = useState(defaultNames.join('\n'));
          const [savedLists, setSavedLists] = useState({}); const [newListName, setNewListName] = useState("");
          const [currentThemeId, setCurrentThemeId] = useState('modern');
          const [isSpinning, setIsSpinning] = useState(false);
          const [winner, setWinner] = useState(null); const [winnerHistory, setWinnerHistory] = useState([]);
          const [soundEnabled, setSoundEnabled] = useState(true);
          const [soundTheme, setSoundTheme] = useState('standard');
          const [mysteryMode, setMysteryMode] = useState(false); const [showSettings, setShowSettings] = useState(false);
          const [projectorMode, setProjectorMode] = useState(false);
          const [showTimer, setShowTimer] = useState(false);
          const [hubImage, setHubImage] = useState(null); const [showHelp, setShowHelp] = useState(false);
          const [showImport, setShowImport] = useState(false);
          const [showGroups, setShowGroups] = useState(false);
          const [hiddenNames, setHiddenNames] = useState([]); 
          const [concepts, setConcepts] = useState(defaultConcepts); 
          const [showConceptEdit, setShowConceptEdit] = useState(false);
          const [battleMode, setBattleMode] = useState(false);
          const [battleStage, setBattleStage] = useState('idle');
          const [battleContestants, setBattleContestants] = useState([null, null]);
          const [bloomMode, setBloomMode] = useState('off'); 
          const [bloomWinner, setBloomWinner] = useState(null);
          const [activeTeams, setActiveTeams] = useState([]); const [teamScores, setTeamScores] = useState([]);
          const [fairMode, setFairMode] = useState(false);
          const [winnerTimerActive, setWinnerTimerActive] = useState(false);
          const [rapidMode, setRapidMode] = useState(false);
          const [rapidTarget, setRapidTarget] = useState(3);
          const [rapidWinners, setRapidWinners] = useState([]);
          
          // HEATMAP STATE
// --- ANIMATION & UTILITIES STATE ---
const [billboardText, setBillboardText] = useState("");
// STICKY NOTES STATE
          const [stickies, setStickies] = useState([]);

          const addSticky = () => {
              const colors = ['#fef3c7', '#dbeafe', '#fce7f3', '#dcfce7']; // Yellow, Blue, Pink, Green
              const randomColor = colors[Math.floor(Math.random() * colors.length)];
              const newNote = { 
                  id: Date.now(), 
                  text: "", 
                  color: randomColor, 
                  rotation: Math.random() * 6 - 3, // Random tilt (-3 to 3 degrees)
                  x: 100 + Math.random() * 50, 
                  y: 100 + Math.random() * 50 
              };
              setStickies([...stickies, newNote]);
          };

          const updateSticky = (id, newText) => {
              setStickies(stickies.map(note => note.id === id ? { ...note, text: newText } : note));
          };

          const deleteSticky = (id) => {
              setStickies(stickies.filter(note => note.id !== id));
          };
          const [showBillboard, setShowBillboard] = useState(false);
         const [trafficLight, setTrafficLight] = useState('green'); 
          const [trafficMode, setTrafficMode] = useState('sidebar'); // 'sidebar', 'floating', 'fullscreen' 
          const [scratchpad, setScratchpad] = useState(localStorage.getItem('spinner_scratchpad') || "");
          const [tempWheelItems, setTempWheelItems] = useState(null); // Allows temporarily swapping the list
          const [chanceAnim, setChanceAnim] = useState(null); // 'coin', 'dice'
          const [chanceResult, setChanceResult] = useState(null);
          // --- BRAIN BREAK / KAGAN STRATEGY STATE ---
          const [showBrainBreak, setShowBrainBreak] = useState(false);
          const [breakAnim, setBreakAnim] = useState(false);
          const [currentBreak, setCurrentBreak] = useState({ 
              title: "Ready?", icon: "", desc: "Click 'New Activity' to pick a strategy." 
          });

          const kaganStrategies = [
              { title: "Think-Pair-Share", icon: "", desc: "1. Think about the answer silently.\n2. Pair up with a neighbor.\n3. Share your thoughts." },
              { title: "RallyRobin", icon: "", desc: "1. Pair up.\n2. Partner A shares one idea.\n3. Partner B shares one idea.\n4. Repeat back and forth." },
              { title: "RoundRobin", icon: "", desc: "1. In teams of 4.\n2. Student 1 shares.\n3. Go clockwise: Student 2, 3, 4 share.\n4. Continue until time is up." },
              { title: "Stand Up, Hand Up, Pair Up", icon: "", desc: "1. Stand up and raise a hand.\n2. Walk around until you find a partner.\n3. High five, put hands down, and discuss." },
              { title: "Mix-Pair-Share", icon: "", desc: "1. Class mixes around the room to music.\n2. Music stops: Pair with closest person.\n3. Teacher asks a question to discuss." },
              { title: "Timed Pair Share", icon: "", desc: "1. Partner A speaks for 30-60 seconds (Partner B listens).\n2. Partner B responds/praises.\n3. Switch roles." },
              { title: "RallyCoach", icon: "", desc: "1. Partner A solves the problem.\n2. Partner B watches and coaches.\n3. Partner B praises.\n4. Switch roles for next problem." },
              { title: "Fan-N-Pick", icon: "", desc: "1. S1 fans the cards.\n2. S2 picks a card & reads it.\n3. S3 answers.\n4. S4 paraphrases/praises.\n5. Rotate roles." },
              { title: "Inside-Outside Circle", icon: "", desc: "1. Form two circles (inner facing out, outer facing in).\n2. Face a partner.\n3. Discuss/Quiz.\n4. Outer circle rotates one step left." },
              { title: "Quiz-Quiz-Trade", icon: "", desc: "1. Everyone has a card.\n2. Find a partner.\n3. Quiz each other.\n4. Trade cards and find a new partner." },
              { title: "One Stray", icon: "", desc: "1. Team works on a problem.\n2. One teammate 'strays' to a new team to share/compare answers.\n3. Strayer returns and reports back." },
              { title: "Gallery Walk", icon: "", desc: "1. Post work on walls.\n2. Teams rotate from poster to poster.\n3. Leave feedback on sticky notes." },
              { title: "Jigsaw", icon: "", desc: "1. Become an expert on one topic.\n2. Form new groups with experts from other topics.\n3. Teach your piece to the group." },
              { title: "Numbered Heads", icon: "", desc: "1. Students number off 1-4.\n2. Team discusses question.\n3. Teacher calls a number (e.g., 'All 3s!').\n4. Only 3s answer." },
              { title: "Showdown", icon: "", desc: "1. Captain reads question.\n2. Everyone writes answer secretly.\n3. Captain calls 'Showdown!'.\n4. Compare and discuss." },
              { title: "Talking Chips", icon: "", desc: "1. Everyone gets 2 chips.\n2. Place a chip in center to speak.\n3. Cannot speak again until all chips are used." },
              { title: "Find Someone Who", icon: "", desc: "1. Walk around with a worksheet.\n2. Find a classmate who knows an answer.\n3. Have them sign your sheet." },
              { title: "Corners", icon: "", desc: "1. Teacher labels corners (A, B, C, D).\n2. Students move to their choice.\n3. Pair up in your corner and discuss why." },
              { title: "3-Step Interview", icon: "", desc: "1. A interviews B.\n2. C interviews D.\n3. RoundRobin: Everyone shares what their partner said." },
              { title: "Team Stand-N-Share", icon: "", desc: "1. All teams stand.\n2. Team 1 shares an idea.\n3. Other teams sit if they had the same idea on their list." },
              { title: "Spend-A-Buck", icon: "", desc: "1. Each student has $1.00 (4 quarters) to vote.\n2. Place quarters on preferred options.\n3. Option with most money wins." },
              { title: "Carousel Feedback", icon: "", desc: "1. Projects on desks.\n2. Teams rotate desk-to-desk.\n3. Discuss and leave feedback forms." },
              { title: "Stir-the-Class", icon: "", desc: "1. Teams stand in circle.\n2. Teacher asks question.\n3. Teams huddle. S1 moves to next team to share answer." },
              { title: "Telephone", icon: "", desc: "1. S1 whispers message to S2.\n2. Continue down the line.\n3. Last person says it out loud. Compare to original." },
              { title: "Pairs Compare", icon: "", desc: "1. Shoulder partners list ideas.\n2. Pair with another couple.\n3. Compare lists and add missing items." }
          ];

          const pickBrainBreak = () => {
              setBreakAnim(true);
              let count = 0; const max = 12;
              const interval = setInterval(() => {
                  const randomIdx = Math.floor(Math.random() * kaganStrategies.length);
                  setCurrentBreak(kaganStrategies[randomIdx]);
                  count++;
                  if (count >= max) {
                      clearInterval(interval);
                      setBreakAnim(false);
                      playSound('win', audioCtxRef, soundTheme);
                  } else {
                      playSound('tick', audioCtxRef, soundTheme);
                  }
              }, 100);
          };

          // --- QUICK POLL STATE ---
          const [showPoll, setShowPoll] = useState(false);
          const [pollCounts, setPollCounts] = useState({ A: 0, B: 0, C: 0, D: 0 });
          const updatePoll = (key, delta) => {
              setPollCounts(prev => ({ ...prev, [key]: Math.max(0, prev[key] + delta) }));
          };

          useEffect(() => { localStorage.setItem('spinner_scratchpad', scratchpad); }, [scratchpad]);

          // TRUE PHYSICS FUNCTIONS
// TRUE PHYSICS FUNCTIONS
          const runChance = (type) => {
              // 1. NUMBER WHEEL (1-10)
              if (type === 'num') {
                  const numbers = Array.from({length: 10}, (_, i) => (i + 1).toString());
                  setTempWheelItems(numbers);
                  setTimeout(() => spin(), 100);
              } 
              // 2. COIN FLIP (Pre-calculate Result)
              else if (type === 'coin') {
                  setChanceResult(Math.random() < 0.5 ? "HEADS" : "TAILS");
                  setChanceAnim('coin');
              } 
              // 3. DICE ROLL (Pre-calculate Result)
              else if (type === 'dice') {
                  setChanceResult(Math.floor(Math.random() * 6) + 1);
                  setChanceAnim('dice');
              }
          };

          const [participation, setParticipation] = useState({});
          const [showHeatmap, setShowHeatmap] = useState(false);

          const fileInputRef = useRef(null); 
          const canvasRef = useRef(null); const canvasRef2 = useRef(null);
          const confettiCanvasRef = useRef(null); const containerRef = useRef(null); const audioCtxRef = useRef(null); 
          const rotationRef = useRef(0); const rotationRef2 = useRef(0);
          const velocityRef = useRef(0); const velocityRef2 = useRef(0);
          const lastTickRef = useRef(0); const isSpinningRef = useRef(false); 
          const pointerRef = useRef(0);
          const pointerRef2 = useRef(0); 

          const theme = THEMES[currentThemeId];
const activeNames = useMemo(() => tempWheelItems || names.filter(n => !hiddenNames.includes(n)), [names, hiddenNames, tempWheelItems]);          useEffect(() => { const saved = localStorage.getItem('spinner_lists'); if(saved) setSavedLists(JSON.parse(saved)); }, []);
// 1. SMART SAVE (With Overwrite/Update Confirmation)
          const saveList = () => { 
              const nameToSave = newListName.trim();
              if(!nameToSave) return;
              
              // CHECK: Does this class already exist?
              if (savedLists[nameToSave]) {
                  // Ask user if they want to UPDATE the existing class
                  if (!window.confirm(`Class "${nameToSave}" already exists.\n\nDo you want to UPDATE it with the current names and settings?`)) {
                      return; // User clicked Cancel
                  }
              }

              // GATHER DATA (Names + All Settings)
              const saveData = {
                  names: names,
                  theme: currentThemeId,
                  bloomMode: bloomMode,
                  battleMode: battleMode,
                  mysteryMode: mysteryMode,
                  concepts: concepts,
                  soundTheme: soundTheme,
                  fairMode: fairMode,
                  rapidTarget: rapidTarget
              };

              // PERFORM SAVE
              setSavedLists(prev => {
                  const updated = {...prev, [nameToSave]: saveData};
                  try { 
                      localStorage.setItem('spinner_lists', JSON.stringify(updated)); 
                  } catch(e) { 
                      alert("Error: Could not save to browser storage (Quota Exceeded?)"); 
                  }
                  return updated;
              });
              
              alert(`Class "${nameToSave}" saved successfully!`);
          };

          // 2. SMART LOAD (Prepares for Update)
          const handleLoadClass = (key) => {
              const data = savedLists[key];
              if (!data) return;

              // AUTO-FILL Name Box (So you can easily Update/Resave)
              setNewListName(key); 

              // Load Names
              if (Array.isArray(data)) {
                  // Handle Old Format
                  setNames(data);
                  setInputText(data.join('\n'));
                  setBattleMode(false); setBloomMode('off'); setMysteryMode(false);
              } else {
                  // Handle New Format (Names + Settings)
                  if(data.names) { setNames(data.names); setInputText(data.names.join('\n')); }
                  if(data.theme) setCurrentThemeId(data.theme);
                  
                  // Load Modes (Safe checks)
                  if(data.bloomMode !== undefined) setBloomMode(data.bloomMode);
                  if(data.battleMode !== undefined) setBattleMode(data.battleMode);
                  if(data.mysteryMode !== undefined) setMysteryMode(data.mysteryMode);
                  if(data.concepts) setConcepts(data.concepts);
                  if(data.soundTheme) setSoundTheme(data.soundTheme);
                  if(data.fairMode !== undefined) setFairMode(data.fairMode);
                  if(data.rapidTarget) setRapidTarget(data.rapidTarget);
              }
              
              // Reset Game State
              setHiddenNames([]); 
              setParticipation({});
              setWinner(null);
          };

          // 3. ROBUST DELETE (With "Are you sure?" Popup)
          const handleDeleteClass = (e, key) => {
              // PREVENT BUBBLING: Ensure click hits ONLY the delete button
              e.preventDefault();
              e.stopPropagation(); 
              
              // CONFIRMATION POPUP
              if (window.confirm(`Are you sure you want to permanently delete "${key}"?\n\nThis cannot be undone.`)) {
                  setSavedLists(prev => {
                      const updated = { ...prev };
                      delete updated[key];
                      localStorage.setItem('spinner_lists', JSON.stringify(updated));
                      return updated;
                  });
              }
          };
          
          const updateNames = (t) => { setInputText(t);
          setNames(t.split('\n').filter(n=>n.trim())); };
          const performImport = (l) => { setNames(l); setInputText(l.join('\n')); setShowImport(false); setHiddenNames([]); setParticipation({}); };
          const toggleHidden = (n) => { setHiddenNames(prev => prev.includes(n) ? prev.filter(x => x !== n) : [...prev, n]); };
          const shuffleNames = () => { const s=[...names].sort(()=>Math.random()-0.5); setInputText(s.join('\n')); setNames(s); };
const removeWinner = () => {
    if (winner && !rapidMode && winner !== "Group Complete!" && !tempWheelItems) {
         setHiddenNames(prev => [...prev, winner]);
    }
    setWinner(null);
    setBloomWinner(null); 
    setTempWheelItems(null); // RESET WHEEL TO STUDENTS
    setChanceAnim(null);     // RESET COIN/DICE
    setWinnerTimerActive(false); 
    if(rapidMode) { setRapidMode(false); setRapidWinners([]); }
};
          const handleImageUpload = (e) => { const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onload=(evt)=>{ const i=new Image(); i.onload=()=>{setHubImage(i);
          if(canvasRef.current)drawWheel(canvasRef.current, bloomMode === 'solo' ? concepts : activeNames, rotationRef.current, pointerRef.current, mysteryMode);}; i.src=evt.target.result; }; r.readAsDataURL(f); } };
          const handleStartScoring = (g) => { setActiveTeams(g); setTeamScores(new Array(g.length).fill(0)); setShowGroups(false); };
          const handleUpdateScore = (i,c) => { const n=[...teamScores]; n[i]+=c;
          setTeamScores(n); if(soundEnabled) playSound('tick', audioCtxRef, soundTheme); };
          const toggleBloomMode = () => { setBattleMode(false); if (bloomMode === 'off') setBloomMode('solo');
          else if (bloomMode === 'solo') setBloomMode('dual'); else setBloomMode('off'); };

          const startRapidFire = (count) => {
              setRapidMode(true);
              setRapidTarget(count);
              setRapidWinners([]);
              spin();
          };

          const exportCSV = () => {
              let csvContent = "data:text/csv;charset=utf-8,Name,Count\n";
              names.forEach(n => {
                  csvContent += `${n},${participation[n] || 0}\n`;
              });
              const encodedUri = encodeURI(csvContent);
              const link = document.createElement("a");
              link.setAttribute("href", encodedUri);
              link.setAttribute("download", "class_participation.csv");
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          };

          const drawWheel = (canvas, items, currentRotation, currentPointer, isMystery) => {
            if (!canvas) return;
            let size = 300; 
            const isDual = bloomMode === 'dual';
            if (isDual && containerRef.current && containerRef.current.offsetWidth > 0) size = Math.min(containerRef.current.offsetWidth / 2.2, containerRef.current.offsetHeight) * 0.95;
            else if (containerRef.current && containerRef.current.offsetWidth > 0) size = Math.min(containerRef.current.offsetWidth, containerRef.current.offsetHeight) * 0.95;
            if (size < 50) size = 300;
            if (canvas.width !== size || canvas.height !== size) { canvas.width = size; canvas.height = size;
            }
            const ctx = canvas.getContext('2d'); if (!ctx) return;
            const { width, height } = canvas; const cx = width / 2; const cy = height / 2;
            const radius = Math.max(0, width / 2 - 25);
            ctx.clearRect(0, 0, width, height);
            if (items.length === 0) { ctx.fillStyle = theme.text; ctx.font = "16px sans-serif"; ctx.textAlign = "center"; ctx.fillText("No items!", cx, cy); return;
            }
            items.forEach((name, i) => {
              const start = i * (2 * Math.PI / items.length) + currentRotation; const end = (i + 1) * (2 * Math.PI / items.length) + currentRotation;
              ctx.beginPath(); ctx.moveTo(cx, cy); ctx.arc(cx, cy, radius, start, end); ctx.fillStyle = theme.colors[i % theme.colors.length]; ctx.fill();
              const g = ctx.createRadialGradient(cx, cy, radius * 0.2, cx, cy, radius); g.addColorStop(0, 'rgba(255,255,255,0.15)'); g.addColorStop(1, 'rgba(0,0,0,0.15)'); ctx.fillStyle = g; ctx.fill();
              ctx.strokeStyle = theme.bg; ctx.lineWidth = 2; ctx.stroke();
              ctx.save(); ctx.translate(cx, cy); ctx.rotate(start + (end - start) / 2); ctx.textAlign = "right"; ctx.fillStyle = "#fff"; ctx.font = `bold ${Math.max(12, Math.min(24, 250 / items.length))}px sans-serif`; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4; 
              const shouldHide = isMystery && isSpinningRef.current && items === activeNames;
              ctx.fillText(shouldHide ? "?"
              : name.substring(0, 18), radius - 20, 6); ctx.restore();
            });
            items.forEach((_, i) => { const a = i * (2 * Math.PI / items.length) + currentRotation; ctx.save(); ctx.translate(cx, cy); ctx.rotate(a); ctx.beginPath(); ctx.arc(radius - 2, 0, 4, 0, Math.PI * 2); const pg = ctx.createRadialGradient(radius - 5, -2, 0, radius - 2, 0, 6); pg.addColorStop(0, '#ffffff'); pg.addColorStop(1, '#64748b'); ctx.fillStyle = pg; ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 3; ctx.fill(); ctx.restore(); });
            ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, 35, 0, 2 * Math.PI); ctx.closePath(); ctx.clip();
            if (hubImage && items === activeNames) { ctx.drawImage(hubImage, cx - 35, cy - 35, 70, 70);
            } else { const hg = ctx.createRadialGradient(cx, cy, 10, cx, cy, 35); hg.addColorStop(0, '#fef3c7'); hg.addColorStop(1, '#b45309'); ctx.fillStyle = hg; ctx.fill();
            ctx.save(); ctx.translate(cx, cy); ctx.beginPath(); for (let i = 0; i < 5; i++) { ctx.lineTo(Math.cos((18 + i * 72) * Math.PI / 180) * 18, -Math.sin((18 + i * 72) * Math.PI / 180) * 18);
            ctx.lineTo(Math.cos((54 + i * 72) * Math.PI / 180) * 8, -Math.sin((54 + i * 72) * Math.PI / 180) * 8);
            } ctx.closePath(); ctx.fillStyle = "#fff"; ctx.shadowColor = "rgba(180, 83, 9, 0.5)"; ctx.shadowBlur = 5; ctx.fill(); ctx.restore(); } ctx.restore();
            ctx.beginPath();
            ctx.arc(cx, cy, 35, 0, 2 * Math.PI); ctx.strokeStyle = "#b45309"; ctx.lineWidth = 4; ctx.stroke();
            ctx.save(); ctx.translate(width - 10, cy); ctx.rotate(currentPointer);
            ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(-40, 0); ctx.lineTo(0, 15); ctx.closePath(); ctx.fillStyle = theme.text; ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur = 5; ctx.fill(); ctx.restore();
          };
          const spin = () => {
            if (isSpinning || (bloomMode !== 'solo' && activeNames.length < 2)) return;
            setWinner(null); setBloomWinner(null); setWinnerTimerActive(false);
            if (battleMode && battleStage === 'idle') { setBattleStage('spinning1'); setBattleContestants([null, null]);
            }
            velocityRef.current = 0.4 + Math.random() * 0.4;
            if (bloomMode === 'dual') velocityRef2.current = 0.4 + Math.random() * 0.3;
            isSpinningRef.current = true; setIsSpinning(true);
          };
          useEffect(() => {
            if (!isSpinning) return;
            let af;
            const animate = () => {
                pointerRef.current *= 0.85;
                if (velocityRef.current > 0.002) {
                
                    velocityRef.current *= 0.985; rotationRef.current += velocityRef.current;
                    if (rotationRef.current >= Math.PI * 2) rotationRef.current -= Math.PI * 2;
                    const currentList = bloomMode === 'solo' ? concepts : activeNames;
                    if (soundEnabled && currentList.length > 0) {
      
                         const slice = (2 * Math.PI) / currentList.length; const passed = Math.floor(rotationRef.current / slice);
                         if (passed !== lastTickRef.current) { playSound('tick', audioCtxRef, soundTheme); lastTickRef.current = passed; pointerRef.current = 0.3 + Math.random() * 0.1; }
                    }
     
                } else velocityRef.current = 0;

                if (bloomMode === 'dual') {
                    pointerRef2.current *= 0.85;
                    if (velocityRef2.current > 0.002) { velocityRef2.current *= 0.985; rotationRef2.current += velocityRef2.current;
                    if (rotationRef2.current >= Math.PI * 2) rotationRef2.current -= Math.PI * 2;
                    } 
                    else velocityRef2.current = 0;
                }

                const mainList = bloomMode === 'solo' ?
                concepts : activeNames;
                drawWheel(canvasRef.current, mainList, rotationRef.current, pointerRef.current, mysteryMode);
                if (bloomMode === 'dual') drawWheel(canvasRef2.current, concepts, rotationRef2.current, pointerRef2.current, false);
                if (velocityRef.current === 0 && (bloomMode !== 'dual' || velocityRef2.current === 0)) {
                    isSpinningRef.current = false;
                    pointerRef.current = 0; pointerRef2.current = 0; setIsSpinning(false);
                    let w = null;
                    if (mainList.length > 0) { const slice = (2 * Math.PI) / mainList.length;
                    let p = (0 - rotationRef.current) % (2 * Math.PI); if (p < 0) p += 2 * Math.PI;
                    const i = Math.floor(p / slice); if (i >= 0 && i < mainList.length) w = mainList[i];
                    }
                    let bw = null;
                    if (bloomMode === 'dual') { const slice = (2 * Math.PI) / concepts.length;
                    let p = (0 - rotationRef2.current) % (2 * Math.PI); if (p < 0) p += 2 * Math.PI;
                    const i = Math.floor(p / slice); if (i >= 0 && i < concepts.length) bw = concepts[i];
                    }

                    if (rapidMode && w) {
                         const newWinners = [...rapidWinners, w];
                         setRapidWinners(newWinners);
                         setHiddenNames(prev => [...prev, w]); 
                         // HEATMAP UPDATE
                         setParticipation(prev => ({ ...prev, [w]: (prev[w] || 0) + 1 }));
                         playSound('win', audioCtxRef, soundTheme); 
                         FireConfetti(confettiCanvasRef.current);
                         
                         if (newWinners.length < rapidTarget && activeNames.length > 1) {
                             setTimeout(() => {
                                 velocityRef.current = 0.5 + Math.random() * 0.5; // Fast spin
               
                                 isSpinningRef.current = true;
                                 setIsSpinning(true);
                             }, 800);
                         } else {
                             setWinner("Group Complete!");
                         }
                         return;
                    }

                    if (battleMode && battleStage === 'spinning2' && w === battleContestants[0]) { velocityRef.current = 0.05 + Math.random() * 0.05;
                    af = requestAnimationFrame(animate); return; }

                    if (battleMode) {
                        if (battleStage === 'spinning1') { setBattleContestants([w, null]);
                        setBattleStage('waiting'); if (soundEnabled) playSound('tick', audioCtxRef, soundTheme); setTimeout(() => { setBattleStage('spinning2'); velocityRef.current = 0.4 + Math.random() * 0.4; isSpinningRef.current = true; setIsSpinning(true); }, 1000);
                        } 
                        else if (battleStage === 'spinning2') { setBattleContestants(prev => [prev[0], w]);
                        setBattleStage('finished'); if (soundEnabled) playSound('win', audioCtxRef, soundTheme); FireConfetti(confettiCanvasRef.current); }
                    } else if (w) {
                        setWinner(w);
                        if (bw) setBloomWinner(bw);
                        if (bloomMode !== 'solo') { 
                            const ts = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            setWinnerHistory(p => [{name: w, time: ts}, ...p].slice(0, 10)); 
                            if (fairMode && !hiddenNames.includes(w)) { setHiddenNames(prev => [...prev, w]);
                            }
                            // HEATMAP UPDATE
                            setParticipation(prev => ({ ...prev, [w]: (prev[w] || 0) + 1 }));
                        }
                        if (soundEnabled) playSound('win', audioCtxRef, soundTheme);
                        setTimeout(() => FireConfetti(confettiCanvasRef.current), 10);
                    }
                } else af = requestAnimationFrame(animate);
            };
            animate(); return () => cancelAnimationFrame(af);
          }, [isSpinning, activeNames, hiddenNames, soundEnabled, mysteryMode, soundTheme, battleMode, battleStage, battleContestants, bloomMode, concepts, fairMode, rapidMode, rapidTarget, rapidWinners]);
          useEffect(() => { 
              if (!isSpinning) {
                  const mainList = bloomMode === 'solo' ? concepts : activeNames;
                  drawWheel(canvasRef.current, mainList, rotationRef.current, pointerRef.current, mysteryMode);
                  if (bloomMode === 'dual') drawWheel(canvasRef2.current, concepts, rotationRef2.current, pointerRef2.current, false);
      
               }
          }, [names, hiddenNames, currentThemeId, mysteryMode, isSpinning, hubImage, bloomMode, concepts, activeNames]);
        // --- AUTO-RESIZE FIX ---
          useEffect(() => {
              const handleResize = () => {
                  const mainList = bloomMode === 'solo' ? concepts : activeNames;
                  drawWheel(canvasRef.current, mainList, rotationRef.current, pointerRef.current, mysteryMode);
                  if (bloomMode === 'dual') {
                      drawWheel(canvasRef2.current, concepts, rotationRef2.current, pointerRef2.current, false);
                  }
              };
              window.addEventListener('resize', handleResize);
              return () => window.removeEventListener('resize', handleResize);
          }, [bloomMode, concepts, activeNames, mysteryMode]);

        // Keyboard Hotkeys
          useEffect(() => {
              const k = (e) => {
                  if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
                  if (e.code === 'Space') { 
                  
                      e.preventDefault(); 
                      if (winner) setWinner(null); 
                      else if (battleStage === 'finished') setBattleStage('idle'); 
                      else if (!isSpinning) spin(); 
                
                  }
                  if (e.code === 'Escape') { 
                      if (winner) setWinner(null); 
                      else if (battleStage === 'finished') setBattleStage('idle'); 
                      
                      else { setShowHelp(false); setShowImport(false); setShowGroups(false); setProjectorMode(false); } 
                  }
                  if (e.key === '1') playSound('correct', audioCtxRef);
                  if (e.key === '2') playSound('wrong', audioCtxRef);
                  if (e.key === '3') playSound('drumroll', audioCtxRef);
              };
              window.addEventListener('keydown', k); return () => window.removeEventListener('keydown', k);
          }, [winner, isSpinning, projectorMode, names, showHelp, showImport, showGroups, battleStage]);
          const cssVariables = {
            '--bg-color': theme.bg, '--text-color': theme.text,
            '--sidebar-bg': theme.sidebar, '--accent-color': theme.accent,
            '--grad-start': theme.colors[0], '--grad-end': theme.colors[1]
          };
          const styles = `
            body { margin: 0;
            overflow: hidden; -webkit-tap-highlight-color: transparent; }
            .app { 
                display: flex;
                height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif; 
                background-color: var(--bg-color); color: var(--text-color); 
                transition: background-color 0.3s ease; user-select: none; 
                background-image: ${theme.grad ||
                theme.pattern || 'none'}; 
                background-size: ${theme.bgSize || '400% 400%'};
                animation: ${theme.grad ? 'gradientBG 15s ease infinite' : 'none'};
            }
            .sidebar { width: 320px; background-color: var(--sidebar-bg);
            border-right: 1px solid rgba(128,128,128,0.2); display: flex; flex-direction: column; z-index: 20; transition: all 0.3s;
            }
            .sidebar.projector-hidden { width: 0; opacity: 0; padding: 0;
            overflow: hidden; border: none; }
            .sidebar.closed { transform: translateX(-100%);
            position: fixed; height: 100%; }
            .sidebar.open { transform: translateX(0);
            position: fixed; height: 100%; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
            .main { flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; position: relative; padding: 16px; overflow: hidden;
            }
            .projector-btn { position: absolute; top: 16px; right: 16px;
            z-index: 30; background: var(--sidebar-bg); border-radius: 50%; padding: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); color: var(--text-color); border: 1px solid rgba(128,128,128,0.2);
            }
            .projector-btn:hover { background-color: rgba(128,128,128,0.1); transform: scale(1.1);
            }
            .wheel-container { flex: 1; display: flex; align-items: center;
            justify-content: center; width: 100%; min-height: 0; margin-bottom: 10px; gap: 20px;
            }
            .btn { background: none; border: none; cursor: pointer;
            color: inherit; display: flex; align-items: center; gap: 8px; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 0.95rem; transition: 0.2s;
            }
            .btn:hover { background-color: rgba(128,128,128,0.15);
            }
            .btn:active { transform: scale(0.96);
            }
            .btn:disabled { opacity: 0.5; cursor: not-allowed;
            }
            .btn-primary { background-color: var(--accent-color); color: #fff;
            padding: 18px 48px; font-size: 1.5rem; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); white-space: nowrap; z-index: 10; margin-bottom: 20px;
            }
            .btn-primary:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-2px);
            }
            .input-area { flex: 1; padding: 16px; display: flex;
            flex-direction: column; gap: 12px; overflow-y: auto; }
            .textarea { width: 100%;
            /* Removed fixed height: 100% to fix overlap */
            min-height: 150px; background: rgba(128,128,128,0.05); border: 1px solid rgba(128,128,128,0.2); color: inherit; padding: 12px; border-radius: 8px; resize: vertical; font-family: monospace;
            outline: none; font-size: 16px; }
            .textarea:focus { border-color: var(--accent-color);
            }
            .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); padding: 20px;
            }
            .modal { background: var(--sidebar-bg); padding: 32px; border-radius: 24px;
            text-align: center; max-width: 400px; width: 100%; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            }
            .winner-name { font-size: clamp(2rem, 5vw, 3.5rem); font-weight: 800;
            margin: 16px 0; background: linear-gradient(45deg, var(--grad-start), var(--grad-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; word-break: break-word; line-height: 1.1;
            }
            .section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            opacity: 0.7; margin-bottom: 8px; display: block; font-weight: 700; }
            .list-item { display: flex;
            justify-content: space-between; align-items: center; padding: 8px; background: rgba(128,128,128,0.1); border-radius: 6px; font-size: 0.9rem; margin-bottom: 6px;
            }
            .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; }
            .theme-btn { padding: 10px;
            border: 1px solid rgba(128,128,128,0.2); border-radius: 6px; text-align: left; font-size: 0.85rem; cursor: pointer; transition: 0.2s;
            }
            .theme-btn:hover { border-color: var(--accent-color);
            }
            .mobile-toggle { position: absolute; top: 16px; left: 16px;
            z-index: 30; background: var(--sidebar-bg); border-radius: 50%; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); color: var(--text-color);
            }
            .chip { font-size: 0.8rem; padding: 4px 8px;
            border-radius: 4px; cursor: pointer; border: 1px solid rgba(128,128,128,0.2); transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;
            }
            .chip:hover { background: rgba(128,128,128,0.1);
            }
            .chip.hidden { opacity: 0.4; text-decoration: line-through;
            }
            @media (min-width: 769px) { .sidebar { transform: translateX(0) !important;
            position: relative !important; height: 100% !important; } .mobile-toggle { display: none;
            } }
          `;
          return (
            <div className="app" style={cssVariables}>
                <style>{styles}</style>
                <canvas ref={confettiCanvasRef} style={{position: 'fixed', inset: 0, pointerEvents: 'none', zIndex: 50}} />
                <button onClick={() => setShowSettings(true)} className="mobile-toggle btn"><Icons.Settings /></button>

                <div className={`sidebar ${showSettings ? 'open' 
                : 'closed'} ${projectorMode ? 'projector-hidden' : ''}`}>
                    <div style={{padding: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', borderBottom: '1px solid rgba(128,128,128,0.1)'}}>
                         <h1 style={{margin:0, fontSize: '1.25rem', fontWeight:800, background: `linear-gradient(to right, ${theme.accent}, ${theme.colors[0]})`, WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'}}>Swiss Army Spinner</h1>
                       
                          <div style={{display:'flex', gap: 4}}>
                            <button className="btn" onClick={() => setShowHelp(true)} title="Help" style={{padding: 8}}><Icons.HelpCircle /></button>
                            <button className="btn" onClick={() => setProjectorMode(true)} title="Projector Mode" style={{padding: 8}}><Icons.Maximize /></button>
                      
                          </div>
                    </div>
                    <div className="input-area">
                        
{/* CLASS MANAGER */}
                        <div>
                            <span className="section-title">Class Manager</span>
                            
                            {/* SAVE/UPDATE INPUT */}
                            <div style={{display:'flex', gap:8, marginBottom: 8}}>
                                <input 
                                    value={newListName} 
                                    onChange={(e) => setNewListName(e.target.value)} 
                                    placeholder="Class Name..." 
                                    style={{flex:1, padding: 8, borderRadius: 6, border: '1px solid rgba(128,128,128,0.2)', background:'transparent', color:'inherit'}} 
                                />
                                <button onClick={saveList} className="btn" style={{background:'#7c3aed', color:'white', padding:'0 12px'}} title="Save or Update Class">
                                    <Icons.Save />
                                </button>
                            </div>

                            {/* SAVED CLASSES LIST */}
                            {Object.keys(savedLists).length > 0 && (
                                <div style={{marginTop: 12, display: 'flex', flexDirection: 'column', gap: 6, maxHeight: 150, overflowY: 'auto', paddingRight: 4}}>
                                    <div style={{fontSize: '0.75rem', opacity: 0.5, textTransform: 'uppercase', letterSpacing: 1, fontWeight: 700, marginBottom: 4}}>Saved Classes</div>
                                    
                                    {Object.keys(savedLists).map(key => (
                                        <div key={key} 
                                            style={{
                                                display: 'flex', alignItems: 'center', justifyContent: 'space-between', 
                                                background: 'rgba(128,128,128,0.1)', padding: '4px', 
                                                borderRadius: 6, border: '1px solid rgba(128,128,128,0.1)',
                                                position: 'relative' 
                                            }}
                                        >
                                            
                                            {/* LOAD AREA (Click Name to Load) */}
                                            <div 
                                                onClick={() => handleLoadClass(key)}
                                                style={{
                                                    flex: 1, cursor: 'pointer', padding: '6px 8px', borderRadius: 4,
                                                    fontWeight: 600, fontSize: '0.85rem', display:'flex', alignItems:'center', gap: 8,
                                                    transition: '0.2s'
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.05)'}
                                                onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                                                title="Load this class"
                                            >
                                                <div style={{width: 8, height: 8, borderRadius: '50%', background: theme.accent}}></div>
                                                <div style={{display:'flex', flexDirection:'column'}}>
                                                    <span>{key}</span>
                                                    <span style={{fontSize:'0.7rem', opacity:0.6, fontWeight:400}}>
                                                        {Array.isArray(savedLists[key]) ? `${savedLists[key].length} students` : `${savedLists[key].names.length} students`}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            {/* DELETE BUTTON */}
                                            <button 
                                                onClick={(e) => handleDeleteClass(e, key)}
                                                className="btn"
                                                style={{
                                                    background: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', 
                                                    padding: 0, height: 32, width: 32, justifyContent:'center', borderRadius: 6,
                                                    border: '1px solid rgba(239, 68, 68, 0.2)', marginLeft: 4,
                                                    zIndex: 20, position: 'relative', cursor: 'pointer'
                                                }}
                                                title="Delete Class"
                                                type="button"
                                            >
                                                <Icons.Trash />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                         <div style={{marginTop: 20, display: 'flex', flexDirection: 'column'}}> 
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                <span className="section-title">Names ({activeNames.length}/{names.length})</span>
                    
                                 <div style={{display:'flex', gap:4}}>
                                    <button onClick={() => setShowHeatmap(!showHeatmap)} className="btn" style={{padding:'2px 6px', fontSize:'0.7rem', background: showHeatmap ?
                                    theme.accent : 'rgba(128,128,128,0.1)'}}>
                                       <Icons.BarChart /> {showHeatmap ?
                                    'Editor' : 'Heatmap'}
                                    </button>
                                    {(hiddenNames.length > 0 || Object.keys(participation).length > 0) && (
                  
                                       <button onClick={() => {setHiddenNames([]); setParticipation({})}} style={{fontSize:'0.7rem', color: '#ef4444', background:'none', border:'none', cursor:'pointer'}}><Icons.Refresh /> Reset</button>
                                    )}
                              
                                 </div>
                            </div>
                            
                            {showHeatmap ?
                            (
                                <div style={{height: 120, minHeight: 100, overflowY:'auto', background:'rgba(0,0,0,0.2)', borderRadius:8, padding:8, marginTop: 8}}>
                                    {names.map(n => {
                    
                                         const count = participation[n] || 0;
                                        let color = '#10b981'; 
                               
                                         if(count === 1) color = '#f59e0b'; 
                                        if(count >= 2) color = '#ef4444'; 
                                       
                                        return (
                                            <div key={n} style={{display:'flex', justifyContent:'space-between', fontSize:'0.9rem', marginBottom:4, borderBottom:'1px solid rgba(255,255,255,0.05)', paddingBottom:2}}>
                                             
                                               <span>{n}</span>
                                                <span style={{background:color, color:'white', borderRadius:'10px', padding:'0 6px', fontSize:'0.75rem', fontWeight:'bold'}}>{count}</span>
                                          
                                            </div>
                                        )
                                    })}
                                    <button onClick={exportCSV} className="btn" style={{fontSize:'0.7rem', padding:'2px 6px', background:'rgba(128,128,128,0.1)', width: '100%', marginTop: 8, justifyContent:'center'}}>
                                        <Icons.Save /> Export CSV
                                    </button>
                                  </div>
                            ) : (
                                <textarea value={inputText} onChange={(e) => updateNames(e.target.value)} className="textarea" placeholder="Enter names..." />
                   
                             )}

                            {/* ABSENT TOGGLES */}
                            {!showHeatmap && (
                              
                                 <div style={{display:'flex', flexWrap:'wrap', gap: 4, marginTop: 8}}>
                                    {names.slice(0, 50).map((n, i) => (
                                        <div key={i} onClick={() => toggleHidden(n)} className={`chip ${hiddenNames.includes(n) ?
                                        'hidden' : ''}`} title="Click to hide/show">{n}</div>
                                    ))}
                                </div>
                           
                             )}
                        </div>

                        <div style={{marginTop: 20}}> 
                            <span className="section-title">Tools</span>
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap: 8}}>
                                
                                {/* SHUFFLE */}
                                <button onClick={shuffleNames} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}>
                                    <Icons.Shuffle/> Shuffle
                                </button>

                                {/* MYSTERY MODE */}
                                <button onClick={() => setMysteryMode(!mysteryMode)} className="btn" 
                                    style={{
                                        background: mysteryMode ? theme.accent : 'rgba(128,128,128,0.1)', 
                                        color: mysteryMode ? '#fff' : 'inherit',
                                        boxShadow: mysteryMode ? `0 0 10px ${theme.accent}` : 'none', // GLOW EFFECT
                                        transition: 'all 0.3s ease'
                                    }}>
                                    {mysteryMode ? <Icons.EyeOff/> : <Icons.Eye/>} {mysteryMode ? 'Mystery On' : 'Visible'}
                                </button>
                                
                                {/* BATTLE MODE */}
                                <button onClick={() => {setBattleMode(!battleMode); setBloomMode('off'); setBattleStage('idle'); setRapidMode(false);}} className="btn" 
                                    style={{
                                        background: battleMode ? '#f59e0b' : 'rgba(128,128,128,0.1)', 
                                        color: battleMode ? '#fff' : 'inherit',
                                        boxShadow: battleMode ? '0 0 10px #f59e0b' : 'none' // GLOW EFFECT
                                    }}>
                                    <Icons.Swords/> Battle
                                </button>

                                {/* FAIR MODE */}
                                <button onClick={() => setFairMode(!fairMode)} className="btn" 
                                    style={{
                                        background: fairMode ? '#10b981' : 'rgba(128,128,128,0.1)', 
                                        color: fairMode ? '#fff' : 'inherit',
                                        boxShadow: fairMode ? '0 0 10px #10b981' : 'none' // GLOW EFFECT
                                    }}>
                                    <Icons.Scales/> Fair Mode
                                </button>

                                {/* CONCEPT MODE */}
                                <div style={{display:'flex', gap: 4, gridColumn: 'span 2'}}>
                                    <button onClick={toggleBloomMode} className="btn" 
                                        style={{
                                            flex: 1,
                                            background: bloomMode !== 'off' ? '#3b82f6' : 'rgba(128,128,128,0.1)', 
                                            color: bloomMode !== 'off' ? '#fff' : 'inherit',
                                            boxShadow: bloomMode !== 'off' ? '0 0 10px #3b82f6' : 'none'
                                        }}>
                                        <Icons.Brain/> {bloomMode === 'solo' ? "Concept Only" : bloomMode === 'dual' ? "Name + Concept" : "Concept Mode"}
                                    </button>
                                    <button onClick={() => setShowConceptEdit(true)} className="btn" style={{background: 'rgba(128,128,128,0.1)', padding: 10}} title="Edit Concepts"><Icons.Edit/></button>
                                </div>

                                {/* UTILITIES */}
                                <button onClick={() => setShowImport(true)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}><Icons.Clipboard/> Import</button>
                                <button onClick={() => setShowGroups(true)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}><Icons.Users/> Teams</button>
                                <button onClick={() => setShowBrainBreak(!showBrainBreak)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}> Strategy</button>
                                <button onClick={() => setShowPoll(!showPoll)} className="btn" style={{background: 'rgba(128,128,128,0.1)'}}> Poll</button>
                                
                                {/* TIMER (Full Width) */}
                                <button onClick={() => setShowTimer(!showTimer)} className="btn" 
                                    style={{
                                        gridColumn: 'span 2',
                                        background: showTimer ? theme.accent : 'rgba(128,128,128,0.1)', 
                                        color: showTimer ? '#fff' : 'inherit',
                                        justifyContent: 'center'
                                    }}>
                                    <Icons.Clock/> {showTimer ? "Hide Timer" : "Open Timer"}
                                </button>
                            </div>
                        </div>

                        {/* RAPID FIRE SECTION */}
        
                         <div style={{marginTop: 8}}>
                             <span className="section-title">Rapid Fire (Multi-Pick)</span>
                             <div style={{display:'flex', gap: 8}}>
                  
                                 <button onClick={() => startRapidFire(3)} disabled={isSpinning ||
                                activeNames.length < 3} className="btn" style={{flex:1, background: 'rgba(236, 72, 153, 0.2)', color:'#ec4899', justifyContent:'center'}}>Pick 3</button>
                                <button onClick={() => startRapidFire(5)} disabled={isSpinning ||
                                activeNames.length < 5} className="btn" style={{flex:1, background: 'rgba(236, 72, 153, 0.2)', color:'#ec4899', justifyContent:'center'}}>Pick 5</button>
                             </div>
                        </div>
                        {/* 1. CHANCE MODULE */}
                        <div style={{marginTop: 20}}>
                             <span className="section-title">Chance Tools</span>
                             <div style={{display:'flex', gap: 8}}>
                                 <button onClick={() => runChance('coin')} className="btn" style={{flex:1, background: 'rgba(255,255,255,0.1)', justifyContent:'center'}}>Flip Coin</button>
                                 <button onClick={() => runChance('dice')} className="btn" style={{flex:1, background: 'rgba(255,255,255,0.1)', justifyContent:'center'}}>Roll D6</button>
                                 <button onClick={() => runChance('num')} className="btn" style={{flex:1, background: 'rgba(255,255,255,0.1)', justifyContent:'center'}}>1-10</button>
                             </div>
                        </div>

{/* 2. TRAFFIC LIGHT WIDGET */}
                        <div style={{marginTop: 20}}>
                             {trafficMode === 'sidebar' ? (
                                 <div style={{display:'flex', gap:8}}>
                                     {/* The Lights */}
                                     <div style={{
                                         flex: 1, display:'flex', justifyContent:'space-evenly', 
                                         background:'rgba(0,0,0,0.2)', padding: '12px 0', 
                                         borderRadius: 12, border:'1px solid rgba(255,255,255,0.05)'
                                     }}>
                                        {['red', 'yellow', 'green'].map(color => (
                                            <button key={color} onClick={() => setTrafficLight(color)}
                                                style={{
                                                    width: 40, height: 40, borderRadius: '50%', cursor: 'pointer', border: '3px solid rgba(255,255,255,0.15)',
                                                    background: color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e',
                                                    opacity: trafficLight === color ? 1 : 0.25,
                                                    transform: trafficLight === color ? 'scale(1.15)' : 'scale(1)',
                                                    boxShadow: trafficLight === color ? `0 0 20px ${color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e'}` : 'none',
                                                    transition: 'all 0.3s ease'
                                                }}
                                            />
                                        ))}
                                     </div>
                                     {/* Project Button */}
                                     <button onClick={() => setTrafficMode('floating')} className="btn" style={{width: 50, justifyContent:'center', background:'rgba(255,255,255,0.1)'}} title="Project to Screen">
                                         <Icons.Maximize/>
                                     </button>
                                 </div>
                             ) : (
                                 /* Placeholder when projected */
                                 <button onClick={() => setTrafficMode('sidebar')} className="btn" style={{width:'100%', justifyContent:'center', background:'rgba(34,197,94,0.15)', color:'#4ade80', padding: 16, border:'1px dashed rgba(34,197,94,0.3)'}}>
                                     <Icons.ArrowDown/> Active on Screen (Click to Return)
                                 </button>
                             )}
                        </div>

{/* 4. BILLBOARD WIDGET */}
                        <div style={{marginTop: 20}}>
                             <span className="section-title">Big Message (Billboard)</span>
                             <div style={{display:'flex', gap:8}}>
                                 <input 
                                    value={billboardText} 
                                    onChange={(e) => setBillboardText(e.target.value)} 
                                    placeholder="Ex: Turn to page 42..." 
                                    style={{flex:1, padding: 8, borderRadius: 6, border: '1px solid rgba(128,128,128,0.2)', background:'transparent', color:'inherit'}} 
                                 />
                                 <button 
                                    onClick={() => setShowBillboard(!showBillboard)} 
                                    className="btn" 
                                    style={{background: showBillboard ? theme.accent : 'rgba(255,255,255,0.1)', width: 45, justifyContent:'center'}} 
                                    title={showBillboard ? "Hide Message" : "Project Message"}
                                 >
                                     {showBillboard ? <Icons.EyeOff/> : <Icons.Maximize/>}
                                 </button>
                             </div>
                        </div>

{/* 5. STICKY NOTES BUTTON */}
                        <div style={{marginTop: 20}}>
                             <button onClick={addSticky} className="btn" style={{width:'100%', justifyContent:'center', background:'#fcd34d', color:'#78350f', fontWeight:'bold', boxShadow:'0 4px 0 #b45309'}}>
                                 + Add Sticky Note
                             </button>
                        </div>

{/* 3. SCRATCHPAD */}
                        <div style={{marginTop: 20}}>
                             <span className="section-title">Quick Notes (Auto-Saved)</span>
                             <textarea 
                                value={scratchpad} 
                                onChange={(e) => setScratchpad(e.target.value)} 
                                className="textarea" 
                                placeholder="Jot down reminders, homework, or ideas here..." 
                                style={{minHeight: 80, fontSize:'0.85rem', background:'rgba(255,255,255,0.05)', border:'1px solid rgba(255,255,255,0.1)'}}
                             />
                        </div>

                        {/* GAME SHOW FX */}
                        <div style={{marginTop: 20}}>
                             <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 8}}><span className="section-title">Game Show FX (Hotkeys: 1, 2, 
                                3)</span></div>
                             <div style={{display:'flex', gap: 4}}>
                                 <button onClick={() => playSound('correct', audioCtxRef)} className="btn" style={{flex: 1, background:'#22c55e', color:'white', justifyContent:'center', padding: 8}} title="Correct Answer"><Icons.ThumbsUp /></button>
                    
                                 <button onClick={() => playSound('wrong', audioCtxRef)} className="btn" style={{flex: 1, background:'#ef4444', color:'white', justifyContent:'center', padding: 8}} title="Wrong Answer"><Icons.ThumbsDown /></button>
                                 <button onClick={() => playSound('drumroll', audioCtxRef)} className="btn" style={{flex: 1, background:'#f59e0b', color:'white', justifyContent:'center', padding: 8}} title="Drumroll"><Icons.Zap /></button>
                         
                             </div>
                        </div>
                        
                        <div style={{marginTop: 20}}>
                      
                              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 8}}><span className="section-title">Session History</span>{winnerHistory.length > 0 && <button onClick={() => setWinnerHistory([])} style={{fontSize: '0.7rem', color: '#ef4444', background: 'none', border:'none', cursor:'pointer'}}>Clear</button>}</div>
                             <div style={{maxHeight: 120, overflowY: 'auto', background: 'rgba(128,128,128,0.05)', borderRadius: 8, padding: 8}}>{winnerHistory.length === 0 && <div style={{fontSize: '0.8rem', opacity: 0.5, fontStyle: 'italic', textAlign: 'center'}}>No winners yet.</div>}{winnerHistory.map((item, i) => (<div key={i} style={{fontSize: '0.85rem', display:'flex', justifyContent:'space-between', padding:'4px 0', borderBottom: '1px solid rgba(128,128,128,0.1)'}}><span>{item.name}</span><span style={{opacity: 0.5, fontSize: 
                                '0.75rem'}}>{item.time}</span></div>))}</div>
                        </div>
                    </div>
                </div>

                <div className="main">

{/* BILLBOARD OVERLAY (Clean & Resizable) */}
                    {showBillboard && (
                        <DraggableBox x={50} y={50} style={{zIndex: 55}}>
                            <div style={{
                                background: 'rgba(15, 23, 42, 0.9)', 
                                padding: '30px 40px', 
                                borderRadius: 20, 
                                border: '2px solid rgba(255,255,255,0.1)', 
                                backdropFilter: 'blur(10px)', 
                                boxShadow: '0 20px 50px rgba(0,0,0,0.5)',
                                minWidth: '300px',
                                maxWidth: '80vw',
                                textAlign: 'center',
                                position: 'relative', 
                                resize: 'both',
                                overflow: 'hidden'
                            }}>
                                {/* CLOSE BUTTON */}
                                <button 
                                    onClick={() => setShowBillboard(false)} 
                                    style={{
                                        position: 'absolute', top: 10, right: 10, 
                                        background: 'none', border: 'none', color: '#ef4444', 
                                        cursor: 'pointer', fontWeight: 'bold', fontSize: '1.2rem'
                                    }}
                                    title="Close Billboard"
                                >
                                    <Icons.X />
                                </button>

                                {/* CONTENT (No helper text) */}
                                <div style={{
                                    fontSize: 'clamp(2rem, 5vw, 4rem)', 
                                    fontWeight: 800, 
                                    lineHeight: 1.2,
                                    whiteSpace: 'pre-wrap'
                                }}>
                                    {billboardText || "Class Message"}
                                </div>
                            </div>
                        </DraggableBox>
                    )}

                    {/* STICKY NOTES LAYER (Resizable) */}
                    {stickies.map(note => (
                        <DraggableBox key={note.id} x={note.x} y={note.y} style={{zIndex: 56}}>
                            <div style={{
                                width: 200, 
                                minHeight: 200, 
                                background: note.color,
                                boxShadow: '5px 5px 15px rgba(0,0,0,0.3)',
                                transform: `rotate(${note.rotation}deg)`,
                                padding: 12, 
                                borderRadius: 2, 
                                display: 'flex', 
                                flexDirection: 'column',
                                position: 'relative',
                                resize: 'both',
                                overflow: 'hidden'
                            }}>
                                {/* Close 'X' Button */}
                                <button 
                                    onClick={() => deleteSticky(note.id)} 
                                    style={{
                                        position: 'absolute', top: 5, right: 5,
                                        color: '#000', opacity: 0.4, border: 'none', background: 'none', 
                                        cursor: 'pointer', fontWeight: 'bold', zIndex: 10
                                    }}
                                    title="Delete Note"
                                >
                                    <Icons.X />
                                </button>

                                {/* The Note Input */}
                                <textarea
                                    value={note.text}
                                    onChange={(e) => updateSticky(note.id, e.target.value)}
                                    placeholder="Type note..."
                                    style={{
                                        flex: 1, 
                                        width: '100%',
                                        height: '100%',
                                        background: 'transparent', 
                                        border: 'none', 
                                        outline: 'none', 
                                        resize: 'none', 
                                        color: '#333', 
                                        fontFamily: '"Comic Sans MS", "Marker Felt", sans-serif', 
                                        fontSize: '1.1rem',
                                        lineHeight: 1.4,
                                        marginTop: 14
                                    }}
                                />
                                
                                {/* Visual cue for resize handle in bottom-right */}
                                <div style={{
                                    position:'absolute', bottom: 2, right: 2, 
                                    width: 12, height: 12, pointerEvents:'none',
                                    borderBottom: '2px solid rgba(0,0,0,0.1)', 
                                    borderRight: '2px solid rgba(0,0,0,0.1)'
                                }}/>
                            </div>
                        </DraggableBox>
                    ))}

{/* STICKY NOTES LAYER (Resizable) */}
                    {stickies.map(note => (
                        <DraggableBox key={note.id} x={note.x} y={note.y} style={{zIndex: 56}}>
                            <div style={{
                                width: 200, 
                                minHeight: 200, 
                                background: note.color,
                                boxShadow: '5px 5px 15px rgba(0,0,0,0.3)',
                                transform: `rotate(${note.rotation}deg)`,
                                padding: 12, 
                                borderRadius: 2, 
                                display: 'flex', 
                                flexDirection: 'column',
                                position: 'relative',
                                resize: 'both',     // <--- Added Resize
                                overflow: 'hidden'  // <--- Required for Resize
                            }}>
                                {/* Close 'X' Button */}
                                <button 
                                    onClick={() => deleteSticky(note.id)} 
                                    style={{
                                        position: 'absolute', top: 5, right: 5,
                                        color: '#000', opacity: 0.4, border: 'none', background: 'none', 
                                        cursor: 'pointer', fontWeight: 'bold', zIndex: 10
                                    }}
                                    title="Delete Note"
                                >
                                    <Icons.X />
                                </button>

                                {/* The Note Input */}
                                <textarea
                                    value={note.text}
                                    onChange={(e) => updateSticky(note.id, e.target.value)}
                                    placeholder="Type note..."
                                    style={{
                                        flex: 1, 
                                        width: '100%', /* Ensure text area grows */
                                        height: '100%',
                                        background: 'transparent', 
                                        border: 'none', 
                                        outline: 'none', 
                                        resize: 'none', /* Disable internal text drag, use container instead */
                                        color: '#333', 
                                        fontFamily: '"Comic Sans MS", "Marker Felt", sans-serif', 
                                        fontSize: '1.1rem',
                                        lineHeight: 1.4,
                                        marginTop: 14
                                    }}
                                />
                                
                                {/* Visual cue for resize handle in bottom-right */}
                                <div style={{
                                    position:'absolute', bottom: 2, right: 2, 
                                    width: 12, height: 12, pointerEvents:'none',
                                    borderBottom: '2px solid rgba(0,0,0,0.1)', 
                                    borderRight: '2px solid rgba(0,0,0,0.1)'
                                }}/>
                            </div>
                        </DraggableBox>
                    ))}
{/* KAGAN STRATEGY WIDGET */}
                    {showBrainBreak && (
                        <DraggableBox x={100} y={150} style={{zIndex: 55}}>
                            <div style={{
                                background: 'linear-gradient(135deg, #8b5cf6, #6d28d9)', 
                                padding: 0, borderRadius: 16, width: 320, textAlign: 'center',
                                boxShadow: '0 15px 40px rgba(0,0,0,0.5)', border: '1px solid rgba(255,255,255,0.2)',
                                overflow: 'hidden', display: 'flex', flexDirection: 'column'
                            }}>
                                {/* HEADER */}
                                <div style={{padding: '12px 16px', background:'rgba(0,0,0,0.2)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                                    <span style={{fontWeight:800, color:'white', textTransform:'uppercase', fontSize:'0.9rem', letterSpacing:1}}> Class Strategy</span>
                                    <button onClick={() => setShowBrainBreak(false)} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.X/></button>
                                </div>

                                {/* CARD CONTENT */}
                                <div style={{padding: 20, flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', minHeight: 250}}>
                                    
                                    {/* ICON */}
                                    <div style={{
                                        fontSize: '4rem', marginBottom: 10, 
                                        transform: breakAnim ? 'scale(1.2) rotate(10deg)' : 'scale(1)',
                                        transition: 'transform 0.1s'
                                    }}>
                                        {currentBreak.icon}
                                    </div>

                                    {/* TITLE */}
                                    <div style={{fontSize:'1.4rem', fontWeight:800, color:'white', marginBottom:12, lineHeight:1.1}}>
                                        {currentBreak.title}
                                    </div>

                                    {/* INSTRUCTIONS */}
                                    <div style={{
                                        background:'rgba(255,255,255,0.1)', padding: 12, borderRadius: 8, 
                                        width: '100%', fontSize: '0.9rem', color: 'rgba(255,255,255,0.9)', 
                                        textAlign: 'left', whiteSpace: 'pre-line', lineHeight: 1.4,
                                        flex: 1
                                    }}>
                                        {currentBreak.desc}
                                    </div>
                                </div>

                                {/* FOOTER BUTTON */}
                                <div style={{padding: 16, paddingTop: 0}}>
                                    <button onClick={pickBrainBreak} className="btn" 
                                        disabled={breakAnim}
                                        style={{
                                            width:'100%', justifyContent:'center', background:'white', color:'#6d28d9', 
                                            fontWeight:800, padding: 12, borderRadius: 10,
                                            transform: breakAnim ? 'scale(0.98)' : 'scale(1)',
                                            opacity: breakAnim ? 0.7 : 1
                                        }}>
                                        <Icons.Shuffle/> {breakAnim ? "Spinning..." : "New Activity"}
                                    </button>
                                </div>
                            </div>
                        </DraggableBox>
                    )}

                    {/* QUICK POLL WIDGET */}
                    {showPoll && (
                        <DraggableBox x={150} y={250} style={{zIndex: 55}}>
                            <div style={{
                                background: 'rgba(15, 23, 42, 0.9)', backdropFilter: 'blur(10px)',
                                padding: 16, borderRadius: 16, width: 280,
                                boxShadow: '0 10px 30px rgba(0,0,0,0.4)', border: '1px solid rgba(255,255,255,0.1)'
                            }}>
                                <div style={{display:'flex',justifyContent:'space-between', marginBottom:15, alignItems:'center'}}>
                                    <span style={{fontWeight:800, color:'#94a3b8', textTransform:'uppercase', fontSize:'0.8rem'}}>Class Vote</span>
                                    <div style={{display:'flex', gap:8}}>
                                        <button onClick={() => setPollCounts({A:0,B:0,C:0,D:0})} style={{fontSize:'0.7rem', color:'#94a3b8', background:'none', border:'none', cursor:'pointer'}}>Reset</button>
                                        <button onClick={() => setShowPoll(false)} style={{background:'none', border:'none', color:'white', cursor:'pointer'}}><Icons.X/></button>
                                    </div>
                                </div>
                                <div style={{display:'flex', gap:12, justifyContent:'space-between'}}>
                                    {['A','B','C','D'].map((opt, i) => (
                                        <div key={opt} style={{display:'flex', flexDirection:'column', alignItems:'center', gap:6, flex:1}}>
                                            <div style={{fontWeight:800, color: i===0?'#ef4444':i===1?'#3b82f6':i===2?'#eab308':'#22c55e'}}>{opt}</div>
                                            <div style={{fontSize:'1.5rem', fontWeight:800}}>{pollCounts[opt]}</div>
                                            <div style={{display:'flex', flexDirection:'column', gap:4, width:'100%'}}>
                                                <button onClick={() => updatePoll(opt, 1)} style={{background:'rgba(255,255,255,0.1)', border:'none', color:'white', borderRadius:4, cursor:'pointer', padding:4}}>+</button>
                                                <button onClick={() => updatePoll(opt, -1)} style={{background:'rgba(255,255,255,0.05)', border:'none', color:'#94a3b8', borderRadius:4, cursor:'pointer', padding:4}}>-</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </DraggableBox>
                    )}
                    
{/* TRAFFIC LIGHT OVERLAY (Floating or Fullscreen) */}
                    {trafficMode !== 'sidebar' && (
                        trafficMode === 'fullscreen' ? (
                            // FULLSCREEN MODE (Locked/Centered)
                            <div style={{position: 'absolute', zIndex: 60, inset: 0, background: 'rgba(15, 23, 42, 0.95)', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>
                                <div style={{display: 'flex', flexDirection: 'column', gap: 40, alignItems: 'center'}}>
                                    {['red', 'yellow', 'green'].map(color => (
                                        <button key={color} onClick={() => setTrafficLight(color)}
                                            style={{
                                                borderRadius: '50%', cursor: 'pointer', border: '4px solid rgba(255,255,255,0.1)',
                                                background: color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e',
                                                width: '20vh', height: '20vh',
                                                opacity: trafficLight === color ? 1 : 0.2,
                                                transform: trafficLight === color ? 'scale(1.1)' : 'scale(1)',
                                                boxShadow: trafficLight === color ? `0 0 100px ${color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e'}` : 'none',
                                                transition: 'all 0.3s ease'
                                            }}
                                        />
                                    ))}
                                    <div style={{display:'flex', gap:8}}>
                                        <button onClick={() => setTrafficMode('floating')} className="btn" style={{padding:12, background:'rgba(255,255,255,0.1)'}} title="Shrink to Widget"><Icons.Minimize/></button>
                                        <button onClick={() => setTrafficMode('sidebar')} className="btn" style={{padding:12, background:'rgba(239, 68, 68, 0.2)', color:'#ef4444'}} title="Close to Sidebar"><Icons.X/></button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            // FLOATING MODE (Draggable)
                            <DraggableBox x={20} y={20} style={{zIndex: 60}}>
                                <div style={{background: 'rgba(15, 23, 42, 0.8)', padding: 12, borderRadius: 16, border: '1px solid rgba(255,255,255,0.1)', backdropFilter: 'blur(10px)', boxShadow: '0 10px 40px rgba(0,0,0,0.5)', display:'flex', gap:12, alignItems:'center'}}>
                                    {['red', 'yellow', 'green'].map(color => (
                                        <button key={color} onClick={() => setTrafficLight(color)}
                                            style={{
                                                borderRadius: '50%', cursor: 'pointer', border: '2px solid rgba(255,255,255,0.1)',
                                                background: color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e',
                                                width: 50, height: 50,
                                                opacity: trafficLight === color ? 1 : 0.2,
                                                transform: trafficLight === color ? 'scale(1.1)' : 'scale(1)',
                                                boxShadow: trafficLight === color ? `0 0 30px ${color === 'red' ? '#ef4444' : color === 'yellow' ? '#eab308' : '#22c55e'}` : 'none',
                                                transition: 'all 0.3s ease'
                                            }}
                                        />
                                    ))}
                                    <div style={{display:'flex', flexDirection:'column', gap:8}}>
                                        <button onClick={() => setTrafficMode('fullscreen')} className="btn" style={{padding:8, background:'rgba(255,255,255,0.1)'}} title="Go Full Screen"><Icons.Maximize/></button>
                                        <button onClick={() => setTrafficMode('sidebar')} className="btn" style={{padding:8, background:'rgba(239, 68, 68, 0.2)', color:'#ef4444'}} title="Close to Sidebar"><Icons.X/></button>
                                    </div>
                                </div>
                            </DraggableBox>
                        )
                    )}

                    {projectorMode && <button 
                    onClick={() => setProjectorMode(false)} className="projector-btn btn" title="Exit Projector Mode"><Icons.Minimize /></button>}
                    <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" style={{ display: 'none' }} />
                    {showTimer && <Timer audioCtx={audioCtxRef} onClose={() => setShowTimer(false)} />}
                    {activeTeams.length > 0 && <Scoreboard teams={activeTeams} scores={teamScores} onUpdateScore={handleUpdateScore} onClose={() => setActiveTeams([])} />}

     
                        {battleMode && (
                        <>
                            <div style={{position: 'absolute', top: '50%', left: '20px', transform: 'translateY(-50%)', zIndex: 10, transition: 'all 0.5s', opacity: battleContestants[0] ?
                            1 : 0.3}}>
                                <div style={{background: theme.colors[0], color: 'white', padding: '20px', borderRadius: 16, textAlign: 'center', boxShadow: '0 10px 30px rgba(0,0,0,0.5)', minWidth: 150}}>
                                    <div style={{fontSize: '0.8rem', textTransform: 'uppercase', opacity: 0.8, fontWeight: 700}}>Player 1</div>
    
                                     <div style={{fontSize: '1.5rem', fontWeight: 800}}>{battleContestants[0] ||
                                    "?"}</div>
                                </div>
                            </div>
                            <div style={{position: 'absolute', top: '50%', right: '20px', transform: 'translateY(-50%)', zIndex: 10, transition: 
                            'all 0.5s', opacity: battleContestants[1] ? 1 : 0.3}}>
                                <div style={{background: theme.colors[1], color: 'white', padding: '20px', borderRadius: 16, textAlign: 'center', boxShadow: '0 10px 30px rgba(0,0,0,0.5)', minWidth: 150}}>
                                    <div style={{fontSize: '0.8rem', textTransform: 'uppercase', opacity: 0.8, fontWeight: 
                                    700}}>Player 2</div>
                                    <div style={{fontSize: '1.5rem', fontWeight: 800}}>{battleContestants[1] ||
                                    "?"}</div>
                                </div>
                            </div>
                        </>
                
                     )}

                    <div ref={containerRef} className="wheel-container">
                        <canvas ref={canvasRef} onClick={spin} style={{maxWidth: '100%', maxHeight: projectorMode ? '90vh' : (showTimer ? '55vh' : '70vh'), cursor: 'pointer', filter: 'drop-shadow(0 10px 20px rgba(0,0,0,0.3))', transition: 'max-height 0.3s ease'}}/>
                        {bloomMode === 'dual' && (
                            <canvas ref={canvasRef2} onClick={spin} style={{maxWidth: '100%', maxHeight: projectorMode ? '90vh' : (showTimer ? '55vh' : '70vh'), cursor: 'pointer', filter: 'drop-shadow(0 10px 20px rgba(0,0,0,0.3))', transition: 'max-height 0.3s ease'}}/>
          
                           )}
                    </div>
                    
                    <button onClick={spin} disabled={isSpinning ||
                    (bloomMode !== 'solo' && activeNames.length < 2)} className="btn btn-primary">
                        {isSpinning ?
                        (battleMode ? (battleStage === 'waiting' ? 'NEXT...' : 'SPINNING...') : 'SPINNING...') : (battleMode ? 'BATTLE SPIN!' : 'SPIN!')}
                    </button>
                </div>

                {battleMode && battleStage === 'finished' && (
                     <div className="modal-overlay">
   
                          <div className="modal" style={{background: 'linear-gradient(135deg, #1e293b, #0f172a)', border: '2px solid rgba(255,255,255,0.1)'}}>
                            <h2 style={{margin: '0 0 20px 0', fontSize: '3rem', fontStyle: 'italic', fontWeight: 900, background: '-webkit-linear-gradient(#fcd34d, #f59e0b)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'}}>VS</h2>
                        
                             <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 20, marginBottom: 30}}>
                                <div style={{textAlign:'center'}}><div style={{fontSize:'2rem', fontWeight:800, color: theme.colors[0]}}>{battleContestants[0]}</div></div>
                                <div style={{width: 2, height: 60, background:'rgba(255,255,255,0.2)'}}></div>
            
                                 <div style={{textAlign:'center'}}><div style={{fontSize:'2rem', fontWeight:800, color: theme.colors[1]}}>{battleContestants[1]}</div></div>
                            </div>
                            <button onClick={() => setBattleStage('idle')} className="btn btn-primary" style={{width: '100%'}}>New Battle</button>
           
                          </div>
                     </div>
                )}
{/* 3D CHANCE ANIMATIONS OVERLAY */}
                {chanceAnim && (
                    <div className="modal-overlay">
                        <div className="modal" style={{background:'transparent', boxShadow:'none', border:'none', pointerEvents: 'none'}}>
                            
                            {/* COIN ANIMATION */}
                            {chanceAnim === 'coin' && (
                                <div className="coin-container">
                                    <div 
                                        className={`coin ${chanceResult === 'HEADS' ? 'flip-to-heads' : 'flip-to-tails'}`} 
                                        onAnimationEnd={() => {
                                            setWinner(chanceResult); // Show final text
                                            playSound('win', audioCtxRef, soundTheme);
                                            FireConfetti(confettiCanvasRef.current);
                                        }}
                                    >
                                        <div className="coin-face face-heads">
                                            <div style={{fontSize:'3rem'}}></div>
                                            <div>HEADS</div>
                                        </div>
                                        <div className="coin-face face-tails">
                                            <div style={{fontSize:'3rem'}}></div>
                                            <div>TAILS</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* DICE ANIMATION */}
                            {chanceAnim === 'dice' && (
                                <div className="dice-container">
                                    <div 
                                        className={`dice roll-to-${chanceResult}`} 
                                        onAnimationEnd={() => {
                                            setWinner(" " + chanceResult);
                                            playSound('win', audioCtxRef, soundTheme);
                                            FireConfetti(confettiCanvasRef.current);
                                        }}
                                    >
                                        <div className="dice-face df-1">1</div>
                                        <div className="dice-face df-2">2</div>
                                        <div className="dice-face df-3">3</div>
                                        <div className="dice-face df-4">4</div>
                                        <div className="dice-face df-5">5</div>
                                        <div className="dice-face df-6">6</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                )}
                
                {winner && !battleMode && (
                    <div className="modal-overlay">
         
                        <div className="modal">
                            <div style={{width: 80, height: 80, background: '#fbbf24', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px auto', boxShadow: '0 0 30px rgba(251, 191, 36, 0.4)'}}><div style={{color:'#78350f'}}><Icons.Trophy/></div></div>
                            
                                <h2 style={{margin:0, opacity: 0.6}}>The winner is</h2>
                            {rapidMode ?
                                (
                                <div style={{margin:'20px 0', maxHeight:'300px', overflowY:'auto'}}>
                                    {rapidWinners.map((n,i) => <div key={i} style={{fontSize:'1.5rem', fontWeight:700, borderBottom:'1px solid rgba(128,128,128,0.2)', padding:'8px'}}>{i+1}. {n}</div>)}
                  
                                      {rapidWinners.length < rapidTarget && <div style={{opacity:0.5, fontStyle:'italic', marginTop:10}}>Picking next...</div>}
                                </div>
                            ) : (
            
                                     <>
                                    <div className="winner-name">{winner}</div>
                                    {bloomMode === 'dual' && bloomWinner && (
 
                                           <div style={{background: 'rgba(59, 130, 246, 0.15)', color: '#60a5fa', padding: '10px', borderRadius: 8, marginTop: -10, marginBottom: 20, fontWeight: 700}}>
                                            
                                             <div style={{fontSize: '0.8rem', opacity: 0.8, textTransform:'uppercase', letterSpacing:1}}>Challenge</div>
                                            <div style={{fontSize: '1.5rem'}}>{bloomWinner}</div>
                                        </div>
        
                                         )}
                                    {winnerTimerActive && <WinnerTimer duration={30} onComplete={() => playSound('bell', audioCtxRef)} />}
                            
                                     {!winnerTimerActive && (
                                        <button onClick={() => setWinnerTimerActive(true)} className="btn" style={{margin:'0 auto', background:'rgba(255,255,255,0.1)', fontSize:'0.9rem'}}>Start 30s Timer</button>
                                    )}
    
                                     </>
                            )}

                            <div style={{display: 'flex', flexDirection: 'column', gap: 12, marginTop: 20}}>
        
<div style={{display: 'flex', flexDirection: 'column', gap: 12, marginTop: 20}}>
                                
                                {/* CONDITION: Is this a Chance Tool (Coin, Dice, 1-10)? */}
                                {(chanceAnim || tempWheelItems) ? (
                                    /* YES: Show simple Close button */
                                    <button onClick={removeWinner} className="btn" style={{justifyContent: 'center', background: 'rgba(255,255,255,0.1)', padding: 12}}>
                                        Close
                                    </button>
                                ) : (
                                    /* NO: Show Student Options (Keep vs Remove) */
                                    <>
                                        <button onClick={() => setWinner(null)} className="btn" style={{justifyContent: 'center', background: 'rgba(128,128,128,0.2)', padding: 12}}>
                                            Keep Name
                                        </button>
                                        <button onClick={removeWinner} className="btn" style={{justifyContent: 'center', background: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', padding: 12}}>
                                            <Icons.UserMinus/> Remove & Close
                                        </button>
                                    </>
                                )}

                            </div>
                 
                            </div>
                        </div>
                    </div>
                )}

                {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
       
                  {showImport && <ImportModal onClose={() => setShowImport(false)} onImport={performImport} />}
                {showGroups && <GroupMakerModal names={activeNames} onClose={() => setShowGroups(false)} onStartScoring={handleStartScoring} />}
                {showConceptEdit && <ConceptModal concepts={concepts} onClose={() => setShowConceptEdit(false)} onSave={setConcepts} />}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>